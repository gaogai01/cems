<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>尖山發電廠 CEMS 即時監測</title>
    <style>
        /* --- 介面樣式 --- */
        body { background-color: #121212; color: #ffffff; font-family: "Segoe UI", sans-serif; margin: 0; padding: 20px; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; color: #448AFF; font-size: 28px; }
        .sub-title { color: #888; font-size: 14px; margin-top: 5px; }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background-color: #1E1E1E;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 12px;
        }

        .unit-name { font-size: 22px; font-weight: bold; color: #fff; }
        
        /* 狀態燈 */
        .status-light { width: 14px; height: 14px; border-radius: 50%; background-color: #444; border: 1px solid #000; }
        .status-ok { background-color: #00E676; box-shadow: 0 0 8px #00E676; } /* 綠 */
        .status-warn { background-color: #FFD700; box-shadow: 0 0 8px #FFD700; } /* 黃 */
        .status-danger { background-color: #FF5252; box-shadow: 0 0 8px #FF5252; } /* 紅 */

        /* 數據列 */
        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #2a2a2a; padding-bottom: 4px;}
        .label { color: #aaa; font-size: 15px; }
        .value-group { text-align: right; }
        
        .value { font-family: 'Courier New', monospace; font-size: 24px; font-weight: bold; }
        .unit { font-size: 12px; color: #666; margin-left: 3px; }

        /* --- 顏色邏輯 (關鍵修改) --- */
        .val-normal { color: #00E5FF; }  /* 正常: 青色 */
        .val-warn { color: #FFD700; }    /* 預警: 黃色 */
        .val-danger { color: #FF5252; }  /* 超標: 紅色 */
        
        #footer-msg { text-align: center; color: #666; margin-top: 30px; font-size: 12px; line-height: 1.6;}
        .legend { display: inline-block; margin: 0 5px; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #000; font-weight: bold;}
    </style>
</head>
<body>

    <header>
        <h1>尖山發電廠 CEMS 監測</h1>
        <div class="sub-title" id="last-update">等待數據更新...</div>
    </header>

    <div id="dashboard" class="grid-container"></div>
    
    <div id="footer-msg">
        資料來源：環境部 15分鐘數據 (AQX_P_186)<br>
        警示規則：
        <span class="legend" style="background:#FFD700;">黃色預警</span> NOx>300 | SO2>120 | 不透光>8
        <span class="legend" style="background:#FF5252;">紅色超標</span> NOx>363 | SO2>133 | 不透光>40
    </div>

    <script>
        // --- 參數設定 ---
        const API_KEY = '473ceb6e-8b72-4fc3-832e-183f324588ad';
        const CONTROL_ID = 'X0501232'; 
        const API_URL = `https://data.moenv.gov.tw/api/v2/aqx_p_186?api_key=${API_KEY}&limit=1000&sort=m_time desc&format=json&filters=cno,eq,${CONTROL_ID}`;

        // --- ⚠️ 警示規則設定 (這裡是核心) ---
        const RULES = {
            NOX: { warn: 300, limit: 363 }, // 黃:300, 紅:363
            SO2: { warn: 120, limit: 133 }, // 黃:120, 紅:133
            OPAC: { warn: 8, limit: 40 }    // 黃:8,   紅:40
        };

        // 煙道 P001 -> 機組 1
        const polNoMap = {};
        for(let i=1; i<=12; i++) polNoMap['P' + String(i).padStart(3, '0')] = i;

        // 1. 初始化畫面
        function initDashboard() {
            const container = document.getElementById('dashboard');
            let html = '';
            for (let i = 1; i <= 12; i++) {
                html += `
                    <div class="card">
                        <div class="card-header">
                            <span class="unit-name">#${i} 機組</span>
                            <div class="status-light" id="status-${i}"></div>
                        </div>
                        <div class="data-row">
                            <span class="label">NOx</span>
                            <div class="value-group">
                                <span class="value val-normal" id="nox-${i}">--</span><span class="unit">ppm</span>
                            </div>
                        </div>
                        <div class="data-row">
                            <span class="label">SO2</span>
                            <div class="value-group">
                                <span class="value val-normal" id="so2-${i}">--</span><span class="unit">ppm</span>
                            </div>
                        </div>
                        <div class="data-row">
                            <span class="label">不透光</span>
                            <div class="value-group">
                                <span class="value val-normal" id="opac-${i}">--</span><span class="unit">%</span>
                            </div>
                        </div>
                    </div>`;
            }
            container.innerHTML = html;
        }

        // 2. 抓取資料
        async function fetchData() {
            const updateLabel = document.getElementById('last-update');
            updateLabel.innerText = "更新中...";

            try {
                const res = await fetch(API_URL);
                const data = await res.json();

                if (data.records && data.records.length > 0) {
                    processData(data.records);
                    const t = data.records[0].m_time;
                    const now = new Date();
                    updateLabel.innerText = `資料時間: ${t} (最後檢查: ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')})`;
                    updateLabel.style.color = "#00E676";
                } else {
                    updateLabel.innerText = "連線成功，但無資料 (可能停機)。";
                    updateLabel.style.color = "#FFAB40";
                }
            } catch (e) {
                console.error(e);
                updateLabel.innerText = "連線失敗";
                updateLabel.style.color = "#FF5252";
            }
        }

        // 3. 處理資料
        function processData(records) {
            let units = {};
            // 初始化空物件
            for(let i=1; i<=12; i++) units[i] = { nox: null, so2: null, opac: null };

            records.forEach(r => {
                let pNo = r.polno || r.PolNo;
                let id = polNoMap[pNo];
                
                if (id) {
                    let name = r.itemdesc || ""; 
                    let val = parseFloat(r.m_value);
                    
                    if (name.includes("氮氧化物")) {
                        if(units[id].nox === null) units[id].nox = val;
                    } else if (name.includes("二氧化硫")) {
                        if(units[id].so2 === null) units[id].so2 = val;
                    } else if (name.includes("不透光") || name.includes("Opac")) { 
                        if(units[id].opac === null) units[id].opac = val;
                    }
                }
            });

            for(let i=1; i<=12; i++) updateCard(i, units[i]);
        }

        // 4. 更新卡片 (實作紅黃燈邏輯)
        function updateCard(id, data) {
            let isWarning = false; 
            let isDanger = false;  

            // --- NOx 判斷 (紅:363, 黃:300) ---
            const noxEl = document.getElementById(`nox-${id}`);
            if (data.nox !== null) {
                noxEl.innerText = data.nox.toFixed(2);
                
                if (data.nox > RULES.NOX.limit) {
                    noxEl.className = "value val-danger"; 
                    isDanger = true;
                } else if (data.nox > RULES.NOX.warn) {
                    noxEl.className = "value val-warn";
                    isWarning = true;
                } else {
                    noxEl.className = "value val-normal";
                }
            }

            // --- SO2 判斷 (紅:133, 黃:120) ---
            const so2El = document.getElementById(`so2-${id}`);
            if (data.so2 !== null) {
                so2El.innerText = data.so2.toFixed(2);

                if (data.so2 > RULES.SO2.limit) {
                    so2El.className = "value val-danger";
                    isDanger = true;
                } else if (data.so2 > RULES.SO2.warn) {
                    so2El.className = "value val-warn"; 
                    isWarning = true;
                } else {
                    so2El.className = "value val-normal";
                }
            }

            // --- 不透光 判斷 (紅:40, 黃:8) ---
            const opacEl = document.getElementById(`opac-${id}`);
            if (data.opac !== null) {
                opacEl.innerText = data.opac.toFixed(2);
                
                if (data.opac > RULES.OPAC.limit) {
                    opacEl.className = "value val-danger";
                    isDanger = true;
                } else if (data.opac > RULES.OPAC.warn) {
                    opacEl.className = "value val-warn";
                    isWarning = true;
                } else {
                    opacEl.className = "value val-normal";
                }
            }

            // --- 右上角狀態燈 ---
            const light = document.getElementById(`status-${id}`);
            if (data.nox !== null || data.so2 !== null) {
                if (isDanger) light.className = "status-light status-danger"; // 紅燈
                else if (isWarning) light.className = "status-light status-warn"; // 黃燈
                else light.className = "status-light status-ok"; // 綠燈
            } else {
                light.className = "status-light"; // 滅燈
            }
        }

        initDashboard();
        fetchData();
        setInterval(fetchData, 60000);

    </script>
</body>
</html>
