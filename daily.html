<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥å·¡æŸ¥ç´€éŒ„ - å°–å±±ç™¼é›»å» </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --bg-body: #f4f7f6; --bg-card: #ffffff; --text-main: #2c3e50; --text-sub: #666; --text-value: #2c3e50;
            --border-color: #e0e0e0; --primary: #007bff; 
            --gauge-val: #29b6f6; --gauge-bg: #0d47a1; 
        }
        [data-theme="dark"] { 
            --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --text-sub: #aaa; --text-value: #ffffff;
            --border-color: #333; 
        }
        
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s; overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; padding: 10px; }

        /* æ¨™é¡Œèˆ‡æŒ‰éˆ•å€ */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
        h2 { margin: 0; font-size: 1.2rem; border-left: 5px solid var(--primary); padding-left: 10px; }
        
        .btn-log { 
            background: #28a745; color: white; border: none; padding: 8px 15px; 
            border-radius: 5px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .btn-log:hover { background: #218838; transform: translateY(-2px); }

        /* å¡ç‰‡ç¶²æ ¼ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .card { background: var(--bg-card); border-radius: 10px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); border-top: 4px solid var(--primary); position: relative; }
        .card h3 { margin: 0 0 10px 0; font-size: 0.9rem; color: var(--text-sub); text-transform: uppercase; font-weight: bold; display: flex; justify-content: space-between; }
        .data-row { display: flex; justify-content: center; align-items: baseline; gap: 5px; margin-bottom: 8px; }
        .value { font-size: 1.8rem; font-weight: 800; color: var(--text-value); line-height: 1; }
        .unit { font-size: 0.8rem; color: var(--text-sub); }
        .gauge-container { height: 8px; width: 100%; background: var(--gauge-bg); border-radius: 4px; position: relative; overflow: hidden; }
        .gauge-bar { height: 100%; width: 0%; background: var(--gauge-val); border-radius: 4px; transition: width 0.5s ease-out; }
        .limit-text { font-size: 0.75rem; color: var(--text-sub); text-align: right; margin-top: 2px; }

        /* åœ–è¡¨å€ */
        .chart-card { background: var(--bg-card); border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        .chart-controls { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        select { padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); }
        .chart-container { position: relative; height: 400px; width: 100%; }
        
        /* --- æ—¥èªŒç”¢ç”Ÿå™¨ Modal --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { background-color: var(--bg-card); margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .modal-body textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; background: var(--bg-body); color: var(--text-main); resize: vertical; line-height: 1.6; }
        .log-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .log-controls input { padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-body); color: var(--text-main); }
        .close-btn { font-size: 1.5rem; cursor: pointer; color: var(--text-sub); }

        #loading { text-align: center; padding: 50px; font-size: 1.2rem; color: #888; }
    </style>
</head>
<body>

<div id="navbar-placeholder"></div>

<div class="container">
    
    <div class="page-header">
        <h2>æœ€æ–°æ•¸æ“šç¸½è¦½ <span style="font-size:0.8rem; color:var(--text-sub); font-weight:normal;" id="lastDate">...</span></h2>
        <button class="btn-log" onclick="openLogModal()">ğŸ“‹ ç”¢ç”Ÿå·¥ä½œæ—¥èªŒ</button>
    </div>

    <div id="loading">è³‡æ–™è¼‰å…¥ä¸­...</div>

    <div id="dashboardGrid" class="dashboard-grid"></div>

    <div class="chart-card" id="lineSection" style="display:none;">
        <h2>æ­·å²è¶¨å‹¢åˆ†æ</h2>
        <div class="chart-controls">
            <label>é¸æ“‡é …ç›®ï¼š</label>
            <select id="chartParam" onchange="updateLineChart()"></select>
        </div>
        <div class="chart-container">
            <canvas id="lineChart"></canvas>
        </div>
    </div>
</div>

<div id="logModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0; color:var(--text-main);">å·¥ä½œæ—¥èªŒç”¢ç”Ÿå™¨</h3>
            <span class="close-btn" onclick="closeLogModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="log-controls">
                <label style="color:var(--text-main)">é¸æ“‡æ—¥æœŸï¼š</label>
                <input type="date" id="logDate">
                <button class="btn-log" onclick="generateLog()">ç”Ÿæˆæ—¥èªŒ</button>
            </div>
            <textarea id="logResult" placeholder="æ—¥èªŒå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
            <div style="margin-top:10px; text-align:right;">
                <button class="btn-log" style="background:#007bff;" onclick="copyLog()">è¤‡è£½å…§å®¹</button>
            </div>
        </div>
    </div>
</div>

<script src="common.js"></script>
<script>
    // æ¯æ—¥ç´€éŒ„ API
    const API_URL = "https://script.google.com/macros/s/AKfycbzJzoU4IyAc6CeKydjbM8iYVyPMsFvMfoR_I50OT7vyNPpH7BZBjlWGEt_DdnUtlUw/exec"; 
    // CEMS API (ç”¨æ–¼æŠ“å–æ©Ÿçµ„é‹è½‰ç‹€æ…‹)
    const CEMS_API_URL = "https://script.google.com/macros/s/AKfycbwPLWcCJhnE_ZnnIbCgk9hNcjo6ikLDR_rzFGCiBFPamXapAj3e-fg1YiJo1THW08T4/exec";

    let rawData = null;
    let lineChart = null;

    function startApp() {
        fetchData();
        // é è¨­æ—¥èªŒæ—¥æœŸç‚ºä»Šå¤©
        document.getElementById('logDate').valueAsDate = new Date();
    }

    async function fetchData() {
        try {
            const res = await fetch(API_URL + "?mode=daily");
            const json = await res.json();
            
            if (json.error) { document.getElementById('loading').innerText = "éŒ¯èª¤: " + json.error; return; }

            if (json.data && json.data.length > 0) {
                rawData = json;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('lineSection').style.display = 'block';
                
                renderDashboard();
                initDropdown();
                updateLineChart();
            } else {
                document.getElementById('loading').innerText = "ç„¡è³‡æ–™";
            }
        } catch (e) { console.error("Error:", e); }
    }

    function renderDashboard() {
        const grid = document.getElementById('dashboardGrid');
        grid.innerHTML = "";
        const latestRow = rawData.data[rawData.data.length - 1];
        document.getElementById('lastDate').innerText = "æ›´æ–°æ™‚é–“: " + latestRow[0]; 

        const targetFields = [
            "å›æ”¶æ°´é‡", "1è™Ÿæ©Ÿé€ æ°´é‡", "2è™Ÿæ©Ÿé€ æ°´é‡", "15000å…¬ç§‰å„²æ°´ä½", "ç”¨æ°´é‡", 
            "å°¿ç´ æ¯”é‡", "å°¿ç´ ç”¨é‡", "å°¿ç´ åº«å­˜", "1è™Ÿæ©Ÿæµ·æ°´å£“åŠ›", "2è™Ÿæ©Ÿæµ·æ°´å£“åŠ›"
        ];

        const headerMap = {};
        rawData.headers.forEach((h, i) => { if(h) headerMap[h.trim()] = i; });

        targetFields.forEach(field => {
            const idx = headerMap[field];
            if (idx !== undefined) {
                const val = parseFloat(latestRow[idx]);
                const max = parseFloat(rawData.limits[idx]) || 100; 
                const unit = rawData.units[idx] || "";
                
                let displayVal = isNaN(val) ? "--" : val;
                let pct = isNaN(val) ? 0 : (val / max) * 100;
                if (pct > 100) pct = 100;

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${field}</h3>
                    <div class="data-row"><span class="value">${displayVal}</span><span class="unit">${unit}</span></div>
                    <div class="gauge-container"><div class="gauge-bar" style="width: ${pct}%"></div></div>
                    <div class="limit-text">ä¸Šé™: ${max}</div>
                `;
                grid.appendChild(card);
            }
        });
    }

    // --- æ—¥èªŒç”¢ç”Ÿå™¨é‚è¼¯ ---
    function openLogModal() { document.getElementById('logModal').style.display = 'block'; }
    function closeLogModal() { document.getElementById('logModal').style.display = 'none'; }
    
    async function generateLog() {
        const dateStr = document.getElementById('logDate').value; // YYYY-MM-DD
        if (!dateStr) return alert("è«‹é¸æ“‡æ—¥æœŸ");
        
        const targetDate = new Date(dateStr);
        const dateDisplay = (targetDate.getMonth()+1) + "æœˆ" + targetDate.getDate() + "æ—¥";
        
        document.getElementById('logResult').value = "è³‡æ–™è®€å–ä¸­...";

        // 1. è®€å– Daily æ•¸æ“š
        // å°‹æ‰¾è©²æ—¥æœŸçš„ row (å‡è¨­æ—¥æœŸæ ¼å¼ç‚º YYYY/MM/DD æˆ– YYYY-MM-DD)
        // ç‚ºäº†ç›¸å®¹æ€§ï¼Œæˆ‘å€‘æŠŠè³‡æ–™åº«æ—¥æœŸå­—ä¸²æ¨™æº–åŒ–æ¯”å°
        let targetRow = null;
        let prevRow = null; // æ˜¨å¤©çš„æ•¸æ“š (ç®—æ°´ä½å·®)
        
        // ç°¡å–®æŸ¥æ‰¾ï¼šè½‰æ›æˆ YYYY-MM-DD å­—ä¸²æ¯”å°
        const targetYMD = dateStr.replace(/\//g, '-'); 
        
        // å°‹æ‰¾ç•¶æ—¥
        for (let i = 0; i < rawData.data.length; i++) {
            let d = rawData.data[i][0].split(' ')[0].replace(/\//g, '-'); // å–æ—¥æœŸéƒ¨åˆ†
            if (d === targetYMD) {
                targetRow = rawData.data[i];
                if (i > 0) prevRow = rawData.data[i-1]; // ä¸Šä¸€ç­†ç•¶ä½œæ˜¨æ—¥ (å‡è¨­è³‡æ–™é€£çºŒ)
                break;
            }
        }

        if (!targetRow) {
            document.getElementById('logResult').value = "æŸ¥ç„¡è©²æ—¥æœŸçš„å·¡æŸ¥ç´€éŒ„è³‡æ–™ã€‚";
            return;
        }

        // å»ºç«‹æ¬„ä½ Map
        const hMap = {};
        rawData.headers.forEach((h, i) => { if(h) hMap[h.trim()] = i; });

        const getVal = (name) => {
            let val = parseFloat(targetRow[hMap[name]]);
            return isNaN(val) ? 0 : val;
        };

        // 2. è®€å– CEMS æ­·å²è³‡æ–™ (æŠ“æ©Ÿçµ„ç‹€æ…‹)
        // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘é‡æ–° fetch CEMS history
        let unitsAM = [], unitsPM = [];
        try {
            const cemsRes = await fetch(CEMS_API_URL + "?type=history");
            const cemsJson = await cemsRes.json();
            
            // ç¯©é¸å‡ºè©²æ—¥æœŸçš„ 08:30 å’Œ 13:30 é™„è¿‘çš„è³‡æ–™
            // ç°¡å–®é‚è¼¯ï¼šæ‰¾åŒ…å«è©²æ—¥æœŸå­—ä¸²ï¼Œä¸”æ™‚é–“æ¥è¿‘çš„
            cemsJson.forEach(row => {
                if (row.t.includes(targetYMD)) {
                    let time = row.t.split(' ')[1]; // HH:mm:ss
                    let hour = parseInt(time.split(':')[0]);
                    
                    // åˆ¤æ–·æ˜¯ä¸Šåˆé‚„æ˜¯ä¸‹åˆ
                    let targetList = (hour >= 8 && hour <= 11) ? unitsAM : 
                                     (hour >= 13 && hour <= 16) ? unitsPM : null;
                    
                    if (targetList && targetList.length === 0) { // åªæŠ“ç¬¬ä¸€ç­†ç¬¦åˆçš„
                        let parts = row.d.split(',');
                        const ITEMS_PER_MACHINE = 27;
                        for(let i=0; i<12; i++) {
                            let status = parts[i * ITEMS_PER_MACHINE + 2];
                            if(status === 'N') targetList.push((i+1));
                        }
                    }
                }
            });
        } catch(e) { console.error("CEMS Fetch Error", e); }

        // å¦‚æœ CEMS æ²’æŠ“åˆ°ï¼Œé¡¯ç¤ºé è¨­
        if(unitsAM.length === 0) unitsAM = ["ç„¡è³‡æ–™"];
        if(unitsPM.length === 0) unitsPM = ["ç„¡è³‡æ–™"];

        // 3. æº–å‚™æ•¸å€¼
        const desalt1 = getVal("1è™Ÿæ©Ÿé€ æ°´é‡");
        const desalt2 = getVal("2è™Ÿæ©Ÿé€ æ°´é‡");
        const totalDesalt = desalt1 + desalt2;
        const waterUsed = getVal("ç”¨æ°´é‡");
        
        const level = getVal("15000å…¬ç§‰å„²æ°´ä½");
        const prevLevel = prevRow ? parseFloat(prevRow[hMap["15000å…¬ç§‰å„²æ°´ä½"]]) : level;
        const levelDiff = (level - prevLevel).toFixed(2);
        const levelTrend = levelDiff >= 0 ? "ä¸Šå‡" : "ä¸‹é™";
        
        // å…¬å¼: æ°´ä½ * 2950
        const realStock = (level * 2950).toFixed(1);
        
        const press1 = getVal("1è™Ÿæ©Ÿæµ·æ°´å£“åŠ›");
        const press2 = getVal("2è™Ÿæ©Ÿæµ·æ°´å£“åŠ›");

        // 4. çµ„åˆæ–‡å­—
        let logText = `å·¥ä½œæ—¥æœŸ:${dateDisplay}ã€‚é€ æ°´è¨­å‚™æ“ä½œï¼Œ#1æµ·æ·¡${desalt1>0?'é‹è½‰':'åœæ©Ÿ'}ï¼šé€ æ°´é‡${desalt1}å…¬å™¸;#2æµ·æ·¡${desalt2>0?'é‹è½‰':'åœæ©Ÿ'}ï¼šé€ æ°´é‡${desalt2}å…¬å™¸;ç•¶æ—¥ç¸½é€ æ°´é‡${totalDesalt}å…¬å™¸ï¼Œç•¶æ—¥ç”¨æ°´é‡${waterUsed}å…¬å™¸;15,000å™¸å„²æ°´æ§½æ°´ä½${level}å…¬å°ºï¼Œæ°´ä½${levelTrend}${Math.abs(levelDiff)}å…¬å°ºï¼Œå¯¦éš›å„²æ°´é‡${realStock}å…¬å™¸ï¼Œä¸Šåˆ08:30è’¸æ°£æµé‡2.9å…¬å™¸/å°æ™‚ï¼Œä¸‹åˆ13:30è’¸æ°£æµé‡2.9å…¬å™¸/å°æ™‚ã€‚`;
        
        logText += `\nä¸Šåˆæ©Ÿçµ„é‹çˆé‹è½‰${unitsAM.length}éƒ¨(${unitsAM.join('ã€')}è™Ÿæ©Ÿ)ï¼Œä¸‹åˆæ©Ÿçµ„é‹çˆé‹è½‰${unitsPM.length}éƒ¨(${unitsPM.join('ã€')}è™Ÿæ©Ÿ)ï¼Œ`;
        logText += `\n${dateDisplay}ä¸Šåˆæµ·æ°´é€²æ°´å£“åŠ›#1:${press1}ã€#2:${press2}barã€‚R.Oç´”æ°´ç³»çµ±ä¿é¤Šç¶­è­·ï¼Œç´”æ°´è¼¸é€è‡³å„ä¾›æ°´æ§½ä½¿ç”¨ã€‚`;

        document.getElementById('logResult').value = logText;
    }

    function copyLog() {
        const textArea = document.getElementById('logResult');
        textArea.select();
        document.execCommand('copy');
        alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
    }

    window.onclick = function(event) { if (event.target == document.getElementById('logModal')) closeLogModal(); }

    // --- è¶¨å‹¢åœ– ---
    function initDropdown() {
        const select = document.getElementById('chartParam');
        if (select.options.length > 0) return;
        for (let i = 2; i < rawData.headers.length; i++) {
            let header = rawData.headers[i];
            if (header) select.innerHTML += `<option value="${i}">${header}</option>`;
        }
    }

    function updateLineChart() {
        const colIdx = parseInt(document.getElementById('chartParam').value);
        const labelName = rawData.headers[colIdx];
        const unit = rawData.units[colIdx] || "";
        const limit = parseFloat(rawData.limits[colIdx]);
        const labels = []; const values = [];

        rawData.data.forEach(row => {
            labels.push(row[0]); 
            values.push(parseFloat(row[colIdx]) || null);
        });

        const ctx = document.getElementById('lineChart').getContext('2d');
        if (lineChart) lineChart.destroy();

        const datasets = [{ label: labelName, data: values, borderColor: '#007bff', backgroundColor: 'rgba(0, 123, 255, 0.1)', borderWidth: 2, pointRadius: 3, fill: true, tension: 0.1 }];
        if (!isNaN(limit)) { datasets.push({ label: 'ä¸Šé™ (' + limit + ')', data: new Array(labels.length).fill(limit), borderColor: '#dc3545', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, fill: false }); }

        lineChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: {display: true, text: unit} } } } });
    }
</script>

</body>
</html>
