<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>尖山發電廠 - 廢油水監控系統</title>
    
    <link rel="stylesheet" href="css/style.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="navbar-placeholder"></div>

    <div class="container">
        <div class="page-header">
            <h1>尖山發電廠 - 廢油水監控</h1>
<div class="header-right">
    <button class="btn-ctrl btn-report" onclick="openOpReport()">📊 操作紀錄表</button>

    <button class="btn-ctrl btn-report" onclick="openWaterReport()">📊 水質紀錄表</button>
    <button class="btn-ctrl" onclick="toggleTheme()" id="themeBtn">🌓</button>
    <div class="status-box">更新: <span id="last-update">...</span></div>
</div>
        </div>

        <div id="app">
            <div class="loading">正在驗證權限並載入數據...</div>
        </div>
    </div>

    <div id="waterReportModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header"><h3>放流水水質紀錄表 (每日平均)</h3><span class="close-btn" onclick="closeWaterReport()">&times;</span></div>
            <div class="chart-controls">
                <label style="color:var(--text-main)">選擇月份：</label>
                <input type="month" id="waterReportMonth" style="padding:5px; border-radius:4px; border:1px solid #ccc;">
                <button class="btn-ctrl btn-report" onclick="generateWaterReport()">🔄 更新預覽</button>
                <button class="btn-ctrl btn-excel" onclick="exportWaterExcel()">📥 下載 Excel</button>
                <button class="btn-ctrl btn-print" onclick="printWaterReport()">🖨️ 列印 / PDF</button>
            </div>
            <div class="modal-body" id="waterReportPreview" style="background:white; color:black; padding:20px;">
                <div style="text-align:center; color:#888;">請選擇月份並點擊更新 (資料來源：廢水歷史數據庫)</div>
            </div>
        </div>
    </div>

<div id="opReportModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header"><h3>廢(污)水操作處理及溫排水水溫紀錄表</h3><span class="close-btn" onclick="closeOpReport()">&times;</span></div>
        <div class="chart-controls">
            <label style="color:var(--text-main)">選擇月份：</label>
            <input type="month" id="opReportMonth" style="padding:5px; border-radius:4px; border:1px solid #ccc;">
            <button class="btn-ctrl btn-report" onclick="generateOpReport()">🔄 更新預覽</button>
            <button class="btn-ctrl btn-excel" onclick="exportOpExcel()">📥 下載 Excel</button>
            <button class="btn-ctrl btn-print" onclick="printOpReport()">🖨️ 列印 / PDF</button>
        </div>
        <div class="modal-body" id="opReportPreview" style="background:white; color:black; padding:10px; overflow-x:auto;">
            <div style="text-align:center; color:#888; padding:30px;">請選擇月份並點擊更新</div>
        </div>
    </div>
</div>

<div class="modal-body" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 15px; background-color: #f4f6f9;">
    
    <div class="chart-controls" style="margin-bottom: 10px; padding: 12px; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
        
        <div style="display: flex; align-items: center; gap: 8px; border-right: 1px solid #eee; padding-right: 15px;">
            <span style="font-weight: bold; color: #555; font-size: 0.9em;">監測對象</span>
            <select id="categorySelect" onchange="renderCheckboxes()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background: #fafafa; font-weight: 500;">
                <option value="level" selected>液位</option>
                <option value="flow">流量</option>
                <option value="ph">pH</option>
                <option value="quality">水質</option>
                <option value="pac">藥劑</option>
            </select>
        </div>

<div style="display: flex; align-items: center; gap: 5px; flex: 1;">
    <span style="font-weight: bold; color: #555; font-size: 0.9em;">時間</span>
    
    <button onclick="changeDate(-1)" style="padding: 4px 10px; cursor: pointer; border: 1px solid #ced4da; background: #fff; border-radius: 4px; color: #555;" title="前一天">◀</button>
    
    <input type="date" id="chartEndDate" onchange="updateChart()" style="padding: 5px 8px; border: 1px solid #ced4da; border-radius: 4px; color: #444; font-family: inherit;">
    
    <button onclick="changeDate(1)" style="padding: 4px 10px; cursor: pointer; border: 1px solid #ced4da; background: #fff; border-radius: 4px; color: #555;" title="後一天">▶</button>

    <select id="timeRangeSelect" onchange="updateChart()" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; background: #fafafa; margin-left: 5px;">
        <option value="24h" selected>近 24 小時</option>
        <option value="7d">近 7 天</option>
        <option value="30d">近 30 天</option>
    </select>
</div>

        <div id="chartStats" style="display:flex; gap:8px; align-items: center; font-size: 0.85rem;">
            </div>
    </div>

    <div id="tagCheckboxes" class="checkbox-container" style="margin-bottom: 10px; padding: 10px 15px; background: #e9ecef; border-radius: 6px; max-height: 80px; overflow-y: auto; border: 1px solid #dee2e6; display: flex; flex-wrap: wrap; gap: 10px;">
        </div>
    
    <div id="chartLoading" style="display:none; text-align:center; padding: 20px; color: #3f51b5; font-weight: bold;">
        <div class="spinner"></div> 數據載入中...
    </div>

    <div class="chart-container" style="flex: 1; position: relative; min-height: 300px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #eee;">
        <canvas id="historyChart"></canvas>
    </div>
</div>

    <script src="js/common.js"></script>  
    <script src="js/config.js"></script>    
    <script src="js/dashboard.js"></script> 
    <script src="js/charts.js"></script>    
    <script src="js/reports.js"></script>   
    <script src="js/operation_report.js"></script> 
    <script>
        // 啟動點：當 common.js 驗證通過後會呼叫此函式
        function startApp() {
            initDashboard(); // 來自 dashboard.js
        }
    </script>
</body>
</html>
