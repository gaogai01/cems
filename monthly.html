<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每月環化紀錄 - 尖山發電廠</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --bg-body: #f4f7f6; --bg-card: #ffffff; --text-main: #2c3e50; --text-sub: #666; --primary: #007bff; 
            --border-color: #e0e0e0;
            --trend-up: #dc3545;   /* 紅色 */
            --trend-down: #28a745; /* 綠色 */
        }
        [data-theme="dark"] { 
            --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --text-sub: #aaa;
            --border-color: #333;
        }
        
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }

        /* 標題與篩選區 */
        .page-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 15px;
            flex-wrap: wrap; gap: 10px;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        h2 { margin: 0; font-size: 1.4rem; border-left: 6px solid var(--primary); padding-left: 12px; }

        .filter-group { display: flex; gap: 10px; align-items: center; }
        .filter-group select { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); font-size: 1rem; cursor: pointer; }

        /* --- 群組容器 --- */
        .group-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .system-group {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; gap: 10px;
        }

        .group-header {
            font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; 
            padding-bottom: 8px; border-bottom: 3px solid var(--primary);
            color: var(--text-main); text-align: center;
        }

        /* --- 卡片網格 (一列兩欄) --- */
        .inner-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .card {
            background: var(--bg-body); 
            border-radius: 8px; padding: 10px;
            border: 1px solid var(--border-color);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .card-title { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 5px; font-weight: bold; min-height: 2.4em; display: flex; align-items: center; }
        .card-value { font-size: 1.4rem; font-weight: 800; color: var(--text-main); line-height: 1.2; margin-bottom: 5px; }
        .card-sub { font-size: 0.75rem; color: var(--text-sub); display: flex; align-items: center; justify-content: space-between; gap: 5px; background: rgba(0,0,0,0.03); padding: 4px; border-radius: 4px; }
        
        .trend-up { color: var(--trend-up); font-weight: bold; }
        .trend-down { color: var(--trend-down); font-weight: bold; }
        .trend-flat { color: var(--text-sub); }

        /* 圖表區 */
        .chart-section { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border-color); margin-top: 30px; }
        .chart-header { margin-bottom: 15px; border-left: 5px solid #666; padding-left: 10px; font-size: 1.2rem; font-weight: bold; color: var(--text-main); }
        .chart-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        select { padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); font-size: 0.9rem; }
        .chart-box { position: relative; height: 400px; width: 100%; }

        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; color: #888; }

        @media (max-width: 768px) {
            .group-container { grid-template-columns: 1fr; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .chart-controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

<div id="navbar-placeholder"></div>

<div class="container">
    <div class="page-header">
        <div class="header-left">
            <h2>每月環化紀錄</h2>
        </div>
        <div class="filter-group">
            <select id="selYear" onchange="renderGroupedCards()"></select>
            <select id="selMonth" onchange="renderGroupedCards()">
                <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
                <option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
                <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option>
                <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
            </select>
        </div>
    </div>

    <div id="loading">資料載入中...</div>

    <div id="groupContainer" class="group-container"></div>

    <div class="chart-section" id="chartSection" style="display:none;">
        <div class="chart-header">年度比較分析</div>
        <div class="chart-controls">
            <label style="color:var(--text-main)">比較項目：</label>
            <select id="chartParam" onchange="updateChart()"></select>
        </div>
        <div class="chart-box">
            <canvas id="comparisonChart"></canvas>
        </div>
    </div>
</div>

<script src="common.js"></script>
<script>
    // 獨立版 Monthly GS 網址
    // 請填入您上一部部署的「每月紀錄」Apps Script 網址
    const API_URL = "https://script.google.com/macros/s/AKfycbwXoH46dO4rlR2XhZ2PFflCTeRooroVBPADiRltxTa-Jp05uZc9sk2OsGKKSzN92ryxtg/exec"; 
    
    let apiData = null; 
    let chartInstance = null;

    function startApp() {
        fetchData();
    }

    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            
            if (json.error) { alert(json.error); return; }
            
            apiData = json;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('chartSection').style.display = 'block';
            
            initDateControls(); // 初始化日期選單
            renderGroupedCards();
            initDropdown();
            updateChart();
            
        } catch (e) {
            console.error(e);
            document.getElementById('loading').innerText = "載入失敗 (請檢查網址)";
        }
    }

    // --- 1. 初始化日期選單 ---
    function initDateControls() {
        const records = apiData.data;
        const years = [...new Set(records.map(r => r['年度']))].sort().reverse();
        
        const selYear = document.getElementById('selYear');
        selYear.innerHTML = "";
        years.forEach(y => {
            selYear.innerHTML += `<option value="${y}">${y}年</option>`;
        });

        // 預設選中最新的年月
        if (records.length > 0) {
            // 找出最後一筆資料 (假設已排序或取最後)
            const latest = records[records.length - 1];
            selYear.value = latest['年度'];
            document.getElementById('selMonth').value = parseInt(latest['月份']);
        }
    }

    function renderGroupedCards() {
        const targetYear = document.getElementById('selYear').value;
        const targetMonth = document.getElementById('selMonth').value;
        
        // 1. 找到目標月份資料
        const targetRecord = apiData.data.find(r => 
            r['年度'] == targetYear && parseInt(r['月份']) == targetMonth
        );

        // 2. 找到去年同月資料
        const prevYearRecord = apiData.data.find(r => 
            r['年度'] == (parseInt(targetYear) - 1) && parseInt(r['月份']) == targetMonth
        );

        const categories = apiData.meta.categories; 
        const headers = apiData.headers;            
        
        // 分組
        const groups = {};
        headers.forEach((headerName, index) => {
            if (headerName === "年度" || headerName === "月份") return;
            let cat = categories[index] ? categories[index].trim() : "其他";
            if (cat === "") cat = "其他";
            if (!groups[cat]) groups[cat] = [];
            const key = headerName.replace(/\n/g, "").trim();
            groups[cat].push({ key: key, name: headerName, index: index }); // 存 index 方便找上限
        });

        // 渲染 HTML
        const container = document.getElementById('groupContainer');
        container.innerHTML = "";

        if (!targetRecord) {
            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:#888;">${targetYear}年${targetMonth}月 無資料</div>`;
            return; // 圖表還是可以畫，所以不 return 整個函式? 不，卡片沒資料就停
        }

        for (const [groupName, fields] of Object.entries(groups)) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'system-group';
            groupDiv.innerHTML = `<div class="group-header">${groupName}</div>`;
            
            const innerGrid = document.createElement('div');
            innerGrid.className = 'inner-grid';

            fields.forEach(field => {
                const key = field.key;
                const name = field.name;
                
                const valNow = parseFloat(targetRecord[key]);
                const displayNow = !isNaN(valNow) ? valNow.toLocaleString() : "--";
                const valPrev = prevYearRecord ? parseFloat(prevYearRecord[key]) : NaN;
                
                // 漲跌顯示
                let subText = "";
                if (!isNaN(valNow) && !isNaN(valPrev) && valPrev !== 0) {
                    let diff = valNow - valPrev;
                    let diffPct = (diff / valPrev) * 100;
                    let trendClass = diff > 0 ? "trend-up" : (diff < 0 ? "trend-down" : "trend-flat");
                    let trendIcon = diff > 0 ? "⬆" : (diff < 0 ? "⬇" : "-");
                    subText = `去年: ${valPrev} <span class="${trendClass}">${trendIcon} ${Math.abs(diffPct).toFixed(1)}%</span>`;
                } else if (prevYearRecord) {
                    subText = `去年: ${isNaN(valPrev) ? "--" : valPrev}`;
                } else {
                    subText = "無去年資料";
                }

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-title">${name}</div>
                    <div class="card-value">${displayNow}</div>
                    <div class="card-sub">${subText}</div>
                `;
                innerGrid.appendChild(card);
            });

            groupDiv.appendChild(innerGrid);
            container.appendChild(groupDiv);
        }
    }

    function initDropdown() {
        const select = document.getElementById('chartParam');
        const headers = apiData.headers;
        headers.forEach(h => {
            if (h === "年度" || h === "月份") return;
            const key = h.replace(/\n/g, "").trim();
            select.innerHTML += `<option value="${key}">${h}</option>`;
        });
    }

    function updateChart() {
        const fieldKey = document.getElementById('chartParam').value;
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        
        const records = apiData.data;
        const years = [...new Set(records.map(r => r['年度']))].sort().reverse();
        // 取選單選中的年度 + 去年 (或者預設最新兩年)
        // 這裡為了邏輯簡單，我們顯示「目前篩選的年度」vs 「去年」
        const selectedYear = document.getElementById('selYear').value;
        const year1 = selectedYear; 
        const year2 = (parseInt(selectedYear) - 1).toString();

        const data1 = new Array(12).fill(null);
        const data2 = new Array(12).fill(null);

        records.forEach(r => {
            const m = parseInt(r['月份']) - 1; 
            const val = parseFloat(r[fieldKey]);
            if (r['年度'] == year1) data1[m] = isNaN(val) ? null : val;
            if (r['年度'] == year2) data2[m] = isNaN(val) ? null : val;
        });

        // --- 新增：取得上限值 ---
        // 1. 找到 fieldKey 對應的原始 header index
        let limitValue = NaN;
        const headerIndex = apiData.headers.findIndex(h => h.replace(/\n/g, "").trim() === fieldKey);
        
        if (headerIndex !== -1) {
            // apiData.meta.upper 是 Row 1
            const rawLimit = apiData.meta.upper[headerIndex];
            limitValue = parseFloat(rawLimit);
        }

        const chartDatasets = [
            {
                label: `${year1}年`,
                data: data1,
                backgroundColor: '#007bff',
                borderRadius: 4,
                order: 2
            },
            {
                label: `${year2}年`,
                data: data2,
                backgroundColor: '#ced4da',
                borderRadius: 4,
                order: 3
            }
        ];

        // 如果有上限，加入紅線 Dataset
        if (!isNaN(limitValue)) {
            chartDatasets.push({
                type: 'line',
                label: `上限 (${limitValue})`,
                data: new Array(12).fill(limitValue),
                borderColor: '#dc3545',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false,
                order: 1 // 確保線在最上層
            });
        }

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
                datasets: chartDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: {
                    title: { display: true, text: `${fieldKey} - 年度比較` },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }
</script>
</body>
</html>
