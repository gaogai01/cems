<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>尿素採購與庫存分析</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        :root { --bg-body: #f0f2f5; --bg-card: #ffffff; --text-main: #2c3e50; --border-color: #e0e0e0; --primary: #3f51b5; --danger: #d32f2f; --warning: #ff9800; --success: #4caf50; }
        [data-theme="dark"] {
            --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --border-color: #333333;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; transition: background 0.3s; }
        
        /* 導航列相關樣式已移至 common.js，這裡移除 */

        .container { max-width: 1200px; margin: 0 auto; padding: 0 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        
        /* 卡片 */
        .card { 
            background: var(--bg-card); border-radius: 10px; padding: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid var(--primary); 
            overflow: hidden;
        }
        .card h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .full-width { grid-column: 1 / -1; }
        
        /* 規格表 */
        .spec-list { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; color: #555; }
        .spec-list li { padding: 6px 0; border-bottom: 1px dashed #eee; line-height: 1.4; }
        .spec-list li b { color: #333; display: inline-block; min-width: 80px; }

        /* 國際行情 */
        .cost-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.9rem; }
        .cost-table td { padding: 8px 4px; border-bottom: 1px dashed #eee; }
        .cost-table .label { color: #555; text-align: left; }
        .cost-table .value { text-align: right; font-weight: bold; color: #333; white-space: nowrap; }
        .cost-table .total-row td { border-top: 2px solid #eee; border-bottom: none; padding-top: 12px; font-size: 1.1rem; color: var(--danger); }
        .input-usd { width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: right; font-weight: bold; color: var(--primary); font-size: 1rem; }
        
        /* 濃度換算 */
        .calc-container { display: flex; gap: 20px; align-items: flex-start; }
        .calc-inputs { flex: 0 0 40%; }
        .calc-chart { flex: 1; height: 220px; position: relative; }
        .calc-group { margin-bottom: 15px; }
        .calc-group label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 0.85rem; color: #555; }
        .calc-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        .calc-result { text-align: right; font-size: 1.1rem; color: var(--primary); font-weight: bold; margin-top: 2px; }

        /* 庫存預測輸入區 */
        .inventory-input { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; }
        .inventory-input div { flex: 1; }
        .inventory-input label { display: block; font-size: 0.85rem; margin-bottom: 4px; font-weight: bold; color: #444; }
        .inventory-input input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1rem; background: #fff; }
        
        /* 橫向捲動表格 */
        .horizontal-scroll { 
            width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; 
            border: 1px solid #eee; border-radius: 5px; margin-top: 10px; padding-bottom: 5px; 
        }
        .h-table { border-collapse: collapse; width: max-content; min-width: 100%; } 
        .h-table th { 
            background: #f8f9fa; position: sticky; left: 0; z-index: 2; padding: 10px; 
            text-align: right; border-right: 2px solid #ddd; border-bottom: 1px solid #eee; 
            white-space: nowrap; font-size: 0.85rem; min-width: 80px; 
        }
        .h-table td { 
            padding: 8px 10px; text-align: center; border-bottom: 1px solid #eee; 
            border-right: 1px dashed #eee; min-width: 60px; font-size: 0.9rem; white-space: nowrap; 
        }
        
        .cell-weekend { color: var(--primary); font-weight: bold; background-color: #f4f7ff; }
        .cell-order { background-color: #fff3cd; color: #856404; font-weight: bold; border: 2px solid #ffc107; } 
        .cell-delivery { background-color: #e3f2fd; color: #0d47a1; font-weight: bold; } 
        .cell-empty { background-color: #e0e0e0; color: #999; }

        /* RWD */
        @media (max-width: 768px) { 
            .container { grid-template-columns: 1fr; gap: 10px; padding: 5px; } 
            .card { padding: 12px; }
            .card h2 { font-size: 1.1rem; }
            .inventory-input { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .inventory-input div { margin-bottom: 0; }
            .calc-container { flex-direction: column; gap: 15px; }
            .calc-inputs { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .calc-group { margin-bottom: 0; }
            .calc-chart { width: 100%; height: 200px; }
            .h-table th, .h-table td { padding: 6px 8px; font-size: 0.85rem; }
            button { padding: 6px 10px; }
        }
    </style>
</head>
<body>

<div id="navbar-placeholder"></div>

<div class="container">

    <div class="card">
        <h2>國際尿素成本 <button onclick="updatePrice()" style="font-size:0.8rem; cursor:pointer; padding:4px 8px; border:1px solid #ccc; border-radius:4px; background:#fff;">更新</button></h2>
        <p style="font-size:0.8rem; color:#666; margin-bottom:8px;">* 請輸入最新國際報價 (USD)：</p>
        <table class="cost-table">
            <tr>
                <td class="label">1. 國際報價</td>
                <td class="value">
                    <input type="number" id="usdPrice" value="325" class="input-usd" oninput="updatePrice()"> 
                    <span style="font-size:0.8rem;">USD/頓</span>
                </td>
            </tr>
            <tr><td class="label">2. 匯率</td><td class="value"><span id="exchangeRate">32.5</span></td></tr>
            <tr style="background-color: #f1f3f5;"><td class="label" style="font-weight:bold;">➡ 原料成本</td><td class="value"><span id="rawCost">10.6</span> <small>元/kg</small></td></tr>
            <tr><td class="label">+ 海運 (東南亞-台灣)</td><td class="value">+ <span id="seaFreight">1.5</span></td></tr>
            <tr><td class="label">+ 轉運 (台灣-澎湖)</td><td class="value">+ <span id="localFreight">2.5</span></td></tr>
            <tr><td class="label">+ 關稅/保險/雜支</td><td class="value">+ <span id="taxMisc">1.6</span></td></tr>
            <tr class="total-row"><td class="label">預估到廠價</td><td class="value"><span id="finalPrice">16.1</span> <small>元/kg</small></td></tr>
        </table>
    </div>

    <div class="card">
        <h2>濃度/比重 換算</h2>
        <div class="calc-container">
            <div class="calc-inputs">
                <div class="calc-group"><label>比重 (SG)</label><input type="number" id="sgInput" placeholder="1.11" step="0.01" oninput="calcConc()"><div class="calc-result" id="concResult">-- %</div></div>
                <div class="calc-group"><label>濃度 (%)</label><input type="number" id="concInput" placeholder="40" step="0.1" oninput="calcSg()"><div class="calc-result" id="sgResult">--</div></div>
            </div>
            <div class="calc-chart"><canvas id="concChart"></canvas></div>
        </div>
    </div>

    <div class="card full-width">
        <h2>庫存消耗與叫貨排程</h2>
        <div class="inventory-input">
            <div><label>目前庫存 (噸)</label><input type="number" id="currentStock" value="262" oninput="predictStock()"></div>
            <div><label>日用量 (噸)</label><input type="number" id="dailyUsage" value="11.7" oninput="predictStock()"></div>
            <div><label>通知交貨 (天)</label><input type="number" id="leadTime" value="10" oninput="predictStock()"></div>
            <div><label>驗收期 (天)</label><input type="number" id="inspectTime" value="5" oninput="predictStock()"></div>
        </div>
        <div class="horizontal-scroll">
            <table class="h-table" id="stockTable"></table>
        </div>
        <div style="margin-top:8px; font-size:0.8rem; display:flex; gap:12px; flex-wrap:wrap;">
            <span style="display:flex; align-items:center;"><div style="width:12px;height:12px;background:#fff3cd;margin-right:5px;border:1px solid #ffc107;"></div> 第0天(叫貨)</span>
            <span style="display:flex; align-items:center;"><div style="width:12px;height:12px;background:#e3f2fd;margin-right:5px;border:1px solid #0d47a1;"></div> 交貨期</span>
            <span style="display:flex; align-items:center; color:#3f51b5; font-weight:bold;">* 藍字: 週末</span>
        </div>
    </div>

    <div class="card full-width">
        <h2>尿素用量比較</h2>
        <div style="height:300px;">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
    
    <div class="card full-width">
        <h2>工業級尿素規範</h2>
        <ul class="spec-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 5px;">
            <li><b>(一) 外觀：</b>白色之顆粒體或結晶體</li><li><b>(二) 全氮量：</b>不得低於 46%</li>
            <li><b>(三) 鐵分：</b>＜ 10 ppm</li><li><b>(四) 游離氨：</b>＜ 150 ppm</li>
            <li><b>(五) 酸鹼度：</b>pH 7.0 ～ 9.8</li><li><b>(六) 甲醛：</b>＜ 100 ppm</li>
        </ul>
    </div>

</div>

<script src="common.js"></script>

<script>
    // ==========================================
    // 3. 主程式邏輯 (startApp)
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbwXoH46dO4rlR2XhZ2PFflCTeRooroVBPADiRltxTa-Jp05uZc9sk2OsGKKSzN92ryxtg/exec";
    const exchangeRate = 32.5; 
    const HOLIDAYS_2025 = [
        "2025-01-01", "2025-01-25", "2025-01-26", "2025-01-27", "2025-01-28", "2025-01-29", "2025-01-30", "2025-01-31",
        "2025-02-28", "2025-04-03", "2025-04-04", "2025-05-30", "2025-05-31", "2025-10-06", "2025-10-10"
    ];

    // 當 common.js 驗證成功後，會呼叫此函式
    function startApp() {
        updatePrice();
        initConcChart();
        predictStock();
        fetchChartData();
    }

    function isWorkDay(date) {
        const day = date.getDay();
        const dateStr = date.toISOString().split('T')[0];
        if (day === 0 || day === 6) return false; 
        if (HOLIDAYS_2025.includes(dateStr)) return false; 
        return true;
    }

    function updatePrice() {
        const ureaUsd = parseFloat(document.getElementById('usdPrice').value) || 0;
        const rawCost = (ureaUsd * exchangeRate) / 1000; 
        const totalCost = rawCost + 1.5 + 2.5 + (rawCost * 0.15);
        document.getElementById('rawCost').innerText = rawCost.toFixed(1);
        document.getElementById('taxMisc').innerText = (rawCost * 0.15).toFixed(1);
        document.getElementById('finalPrice').innerText = totalCost.toFixed(1);
    }

    let concChart;
    function initConcChart() {
        const ctx = document.getElementById('concChart').getContext('2d');
        const dataPoints = [];
        for(let sg=1.00; sg<=1.20; sg+=0.01) {
            let conc = (sg - 1) * 1000 / 2.78;
            dataPoints.push({x: sg, y: conc});
        }

        concChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    { label: '對照曲線', data: dataPoints, borderColor: '#ccc', borderWidth: 2, pointRadius: 0, fill: false, tension: 0.4 },
                    { label: '目前', data: [], backgroundColor: 'red', borderColor: 'red', pointRadius: 6, type: 'scatter' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', title: {display:true, text:'比重'}, min: 1.0, max: 1.2 },
                    y: { title: {display:true, text:'濃度%'}, min: 0, max: 60 }
                },
                plugins: { legend: {display: false} }
            }
        });
    }

    function updateChartPoint(sg, conc) {
        if(concChart) {
            concChart.data.datasets[1].data = [{x: sg, y: conc}];
            concChart.update();
        }
    }

    function calcConc() {
        const sg = parseFloat(document.getElementById('sgInput').value);
        if (sg) {
            let conc = ((sg - 1) * 1000 / 2.78);
            document.getElementById('concResult').innerText = conc.toFixed(1) + " %";
            updateChartPoint(sg, conc);
            document.getElementById('concInput').value = conc.toFixed(1);
        }
    }
    function calcSg() {
        const conc = parseFloat(document.getElementById('concInput').value);
        if (conc) {
            let sg = (1 + (conc * 2.78 / 1000));
            document.getElementById('sgResult').innerText = sg.toFixed(3);
            updateChartPoint(sg, conc);
            document.getElementById('sgInput').value = sg.toFixed(3);
        }
    }

    function predictStock() {
        const stock = parseFloat(document.getElementById('currentStock').value);
        const usage = parseFloat(document.getElementById('dailyUsage').value);
        const leadTime = parseFloat(document.getElementById('leadTime').value); 
        const inspectTime = parseFloat(document.getElementById('inspectTime').value); 
        const safetyStock = (leadTime + inspectTime) * usage; 

        const table = document.getElementById('stockTable');
        table.innerHTML = ""; 

        if (!stock || !usage) return;

        let tempStock = stock;
        let tempDate = new Date();
        let triggerDate = null;
        
        for(let i=0; i<60; i++) {
            if (tempStock <= safetyStock) { triggerDate = new Date(tempDate); break; }
            tempStock -= usage;
            tempDate.setDate(tempDate.getDate() + 1);
        }

        if (triggerDate) {
            while (!isWorkDay(triggerDate)) { triggerDate.setDate(triggerDate.getDate() - 1); }
        }

        let currentSimStock = stock;
        let date = new Date();
        const weekDays = ["日", "一", "二", "三", "四", "五", "六"];
        
        let rowDates = ["<th>日期</th>"];
        let rowWeeks = ["<th>星期</th>"];
        let rowStocks = ["<th>庫存</th>"];
        let rowStatus = ["<th>狀態</th>"];
        
        let deliveryCounter = -1; 

        for(let i=0; i<45; i++) {
            let dateStr = (date.getMonth() + 1) + "/" + date.getDate();
            let dayOfWeek = weekDays[date.getDay()];
            let isWeekend = (date.getDay() === 0 || date.getDay() === 6);
            
            if (triggerDate && date.toDateString() === triggerDate.toDateString()) { deliveryCounter = 0; }

            let status = "";
            let cellClass = "";

            if (deliveryCounter === 0) {
                status = "叫貨";
                cellClass = "cell-order";
                deliveryCounter++;
            } else if (deliveryCounter > 0 && deliveryCounter <= leadTime) {
                status = `D${deliveryCounter}`;
                cellClass = "cell-delivery";
                deliveryCounter++;
            } else if (currentSimStock <= 0) {
                status = "用罄";
                cellClass = "cell-empty";
            }

            rowDates.push(`<td>${dateStr}</td>`);
            rowWeeks.push(`<td style="${isWeekend ? 'color:blue;font-weight:bold;' : ''}">${dayOfWeek}</td>`);
            rowStocks.push(`<td>${currentSimStock.toFixed(1)}</td>`);
            rowStatus.push(`<td class="${cellClass}">${status}</td>`);

            currentSimStock -= usage;
            date.setDate(date.getDate() + 1);
        }

        table.innerHTML = `<tr>${rowDates.join('')}</tr><tr>${rowWeeks.join('')}</tr><tr>${rowStocks.join('')}</tr><tr>${rowStatus.join('')}</tr>`;
    }

    async function fetchChartData() {
        try {
            const res = await fetch(API_URL + "?mode=urea_stats");
            const data = await res.json();
            const usage113 = data["113"] || [154, 175, 174, 219, 193, 224, 285, 253, 258, 212, 184, 176];
            const usage114 = data["114"] || [144, 140, 245, 315, 387, 372, 384, 365, 387, 338, null, null];
            const costData = data["cost"] || [16.2, 16.1, 16.3, 16.5, 16.8, 16.7, 16.4, 16.3, 16.5, 16.6, null, null];
            const months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];

            const ctx = document.getElementById('trendChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        { label: '113年', data: usage113, backgroundColor: 'rgba(200, 200, 200, 0.5)', order: 3 },
                        { label: '114年', data: usage114, backgroundColor: 'rgba(63, 81, 181, 0.8)', order: 2 },
                        { label: '114年 單價', data: costData, borderColor: '#ff9800', type: 'line', yAxisID: 'y1', order: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { position: 'left', title: {display:true, text:'噸'} },
                        y1: { position: 'right', title: {display:true, text:'元'}, grid: {drawOnChartArea: false} }
                    }
                }
            });
        } catch (e) { console.error("圖表載入失敗", e); }
    }
</script>
</body>
</html>
