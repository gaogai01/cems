<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --bg-body: #f0f2f5; --bg-card: #ffffff; --text-main: #333; --border-color: #ddd; }
        [data-theme="dark"] { --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --border-color: #333; }
        
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; gap: 20px; }
        
        h2 { border-left: 5px solid #dc3545; padding-left: 10px; margin-bottom: 15px; }

        .card { background: var(--bg-card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* è¡¨æ ¼æ¨£å¼ */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .admin-table th, .admin-table td { padding: 10px; border-bottom: 1px solid var(--border-color); text-align: left; }
        .admin-table th { background: rgba(0,0,0,0.05); font-weight: bold; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .tag-online { background: #d4edda; color: #155724; }
        .tag-offline { background: #f8d7da; color: #721c24; }
        .tag-pending { background: #fff3cd; color: #856404; }
        
        /* æŒ‰éˆ• */
        button { cursor: pointer; padding: 5px 10px; border-radius: 4px; border: none; font-size: 0.9rem; }
        .btn-approve { background: #28a745; color: white; }
        .btn-update { background: #007bff; color: white; }
        .btn-del { background: #dc3545; color: white; }
        
        select { padding: 5px; border-radius: 4px; }

        @media (max-width: 768px) {
            .admin-table th:nth-child(3), .admin-table td:nth-child(3) { display: none; } /* æ‰‹æ©Ÿéš±è— Email */
        }
    </style>
</head>
<body>

<div id="navbar-placeholder"></div>

<div class="container">
    
    <div class="card">
        <h2>ğŸŸ¢ ç›®å‰ç·šä¸Šäººå“¡</h2>
        <p style="color:#666; font-size:0.9rem;">* é¡¯ç¤ºæœ€è¿‘ 5 åˆ†é˜å…§æœ‰æ´»å‹•çš„ä½¿ç”¨è€…</p>
        <table class="admin-table">
            <thead><tr><th>å§“å</th><th>éƒ¨é–€/è·ç¨±</th><th>æœ€å¾Œæ´»å‹•æ™‚é–“</th><th>ç‹€æ…‹</th></tr></thead>
            <tbody id="online-list"></tbody>
        </table>
    </div>

    <div class="card">
        <h2>â³ å¾…å¯©æ ¸ç”³è«‹</h2>
        <table class="admin-table">
            <thead><tr><th>å§“å</th><th>éƒ¨é–€/è·ç¨±</th><th>Email</th><th>æ¬Šé™è¨­å®š</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="pending-list"></tbody>
        </table>
    </div>

    <div class="card">
        <h2>ğŸ‘¥ äººå“¡æ¬Šé™ç®¡ç†</h2>
        <input type="text" id="searchBox" placeholder="æœå°‹å§“å..." onkeyup="filterUsers()" style="padding:5px; width:200px; margin-bottom:10px;">
        <table class="admin-table">
            <thead><tr><th>å§“å</th><th>éƒ¨é–€/è·ç¨±</th><th>Email</th><th>ç›®å‰æ¬Šé™</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="all-users-list"></tbody>
        </table>
    </div>

</div>

<script src="common.js"></script>

<script>
    // ============================================================
    // 3. ä¸»ç¨‹å¼é‚è¼¯ (startApp) - ç”± common.js å‘¼å«
    // ============================================================
    function startApp() {
        // è¼‰å…¥ä¸»é¡Œ
        if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
        
        // è¼‰å…¥è³‡æ–™
        loadOnlineUsers();
        loadAllUsers();
    }

    // 1. è¼‰å…¥ç·šä¸Šäººå“¡
    async function loadOnlineUsers() {
        const list = document.getElementById('online-list');
        list.innerHTML = '<tr><td colspan="4">è¼‰å…¥ä¸­...</td></tr>';
        
        // æŠ“å–æ‰€æœ‰ä½¿ç”¨è€…ï¼Œç„¶å¾Œåœ¨å‰ç«¯éæ¿¾ (å› ç‚º Firestore æŸ¥è©¢é™åˆ¶)
        const snap = await db.collection('users').get();
        let html = '';
        let count = 0;
        const now = new Date();

        snap.forEach(doc => {
            const u = doc.data();
            if (u.lastSeen) {
                const lastSeenDate = u.lastSeen.toDate();
                const diffMins = (now - lastSeenDate) / 1000 / 60;
                
                // 5 åˆ†é˜å…§ç®—ç·šä¸Š
                if (diffMins <= 5) {
                    count++;
                    html += `<tr>
                        <td>${u.name}</td>
                        <td>${u.dept} ${u.title || ''}</td>
                        <td>${lastSeenDate.toLocaleTimeString()}</td>
                        <td><span class="tag tag-online">Online</span></td>
                    </tr>`;
                }
            }
        });

        if(count === 0) html = '<tr><td colspan="4">ç›®å‰ç„¡äººç·šä¸Š</td></tr>';
        list.innerHTML = html;
    }

    // 2. è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€… (åŒ…å«å¾…å¯©æ ¸)
    async function loadAllUsers() {
        const pendingList = document.getElementById('pending-list');
        const allList = document.getElementById('all-users-list');
        
        const snap = await db.collection('users').orderBy('createdAt', 'desc').get();
        
        let pendingHtml = '';
        let allHtml = '';
        let pendingCount = 0;

        snap.forEach(doc => {
            const u = doc.data();
            const roleOptions = `
                <option value="guest" ${u.role==='guest'?'selected':''}>åœç”¨</option>
                <option value="env" ${u.role==='env'?'selected':''}>å…¨é–‹</option>
                <option value="mech" ${u.role==='mech'?'selected':''}>ç©º+æ²¹</option>
                <option value="ops" ${u.role==='ops'?'selected':''}>æ°´+ç©º+æ²¹</option>
                <option value="admin" ${u.role==='admin'?'selected':''}>å…¨é–‹+å¾Œå°</option>
            `;
            
            // å¾…å¯©æ ¸å€
            if (!u.isApproved) {
                pendingCount++;
                pendingHtml += `<tr>
                    <td>${u.name}</td>
                    <td>${u.dept} ${u.title || ''}</td>
                    <td>${u.email}</td>
                    <td><select id="role-p-${doc.id}">${roleOptions}</select></td>
                    <td><button class="btn-approve" onclick="approveUser('${doc.id}')">æ ¸å‡†</button></td>
                </tr>`;
            }

            // æ‰€æœ‰äººå“¡å€
            allHtml += `<tr class="user-row">
                <td class="u-name">${u.name}</td>
                <td>${u.dept} ${u.title || ''}</td>
                <td>${u.email}</td>
                <td><select id="role-a-${doc.id}">${roleOptions}</select></td>
                <td><button class="btn-update" onclick="updateUser('${doc.id}')">æ›´æ–°</button></td>
            </tr>`;
        });

        if(pendingCount === 0) pendingHtml = '<tr><td colspan="5">ç„¡å¾…å¯©æ ¸ç”³è«‹</td></tr>';
        
        pendingList.innerHTML = pendingHtml;
        allList.innerHTML = allHtml;
    }

    // æ ¸å‡†ç”¨æˆ¶
    function approveUser(uid) {
        const role = document.getElementById(`role-p-${uid}`).value;
        db.collection('users').doc(uid).update({
            isApproved: true,
            role: role,
            isAdmin: (role === 'admin')
        }).then(() => {
            alert("å·²æ ¸å‡†ï¼");
            loadAllUsers(); // é‡æ–°æ•´ç†åˆ—è¡¨
        });
    }

    // æ›´æ–°ç”¨æˆ¶æ¬Šé™
    function updateUser(uid) {
        const role = document.getElementById(`role-a-${uid}`).value;
        const isApproved = (role !== 'guest'); // å¦‚æœè¨­ç‚ºè¨ªå®¢ï¼Œè¦–ç‚ºåœç”¨
        
        db.collection('users').doc(uid).update({
            isApproved: isApproved,
            role: role,
            isAdmin: (role === 'admin')
        }).then(() => {
            alert("æ¬Šé™å·²æ›´æ–°ï¼");
            loadAllUsers();
        });
    }

    // ç°¡å–®æœå°‹åŠŸèƒ½
    function filterUsers() {
        const input = document.getElementById('searchBox').value.toUpperCase();
        const rows = document.querySelectorAll('.user-row');
        rows.forEach(row => {
            const name = row.querySelector('.u-name').innerText.toUpperCase();
            row.style.display = name.includes(input) ? '' : 'none';
        });
    }

    // æ¯åˆ†é˜è‡ªå‹•åˆ·æ–°ç·šä¸Šç‹€æ…‹
    setInterval(loadOnlineUsers, 60000);

</script>

</body>
</html>
