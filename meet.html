<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>環化課廠務會議報告 (動態查詢版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        @media print {
            @page { margin: 10mm; size: A4 portrait; }
            body { background-color: white; padding: 0; }
            .card { break-inside: avoid; box-shadow: none; border: 1px solid #e5e7eb; margin-bottom: 1rem; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print { display: none !important; }
            header { border: none !important; padding-bottom: 0 !important; margin-bottom: 1rem !important; }
            #dateSelector { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-6">

    <div id="loading" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="font-bold">正在從 Google Sheet 讀取最新數據...</p>
        </div>
    </div>

    <header class="mb-8 flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-600">
        <div class="mb-4 md:mb-0">
            <h1 class="text-2xl font-bold text-gray-900" id="headerTitle">廠務會議 - 環化課業務報告</h1>
            <p class="text-sm text-gray-500 mt-1" id="headerSubtitle">數據載入中...</p>
        </div>
        
        <div class="flex flex-col items-end gap-3">
            <div id="dateSelector" class="flex gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200 no-print">
                <div class="flex items-center">
                    <label class="text-xs font-bold text-gray-500 mr-2">基準年度</label>
                    <select id="selYear" class="bg-white border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-20 p-1">
                        </select>
                </div>
                <div class="flex items-center">
                    <label class="text-xs font-bold text-gray-500 mr-2">月份</label>
                    <select id="selMonth" class="bg-white border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-16 p-1">
                        </select>
                </div>
                <button onclick="updateViewFromSelector()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm transition-colors">
                    <i class="fa-solid fa-filter mr-1"></i>更新
                </button>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="window.print()" class="no-print bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow inline-flex items-center transition-colors text-sm">
                    <i class="fa-solid fa-file-pdf mr-2"></i> PDF
                </button>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="dashboardContent" style="opacity: 0.5;">

        <div class="card bg-white p-6 rounded-xl shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-blue-700"><i class="fa-solid fa-water mr-2"></i> 海淡造水量</h2>
                <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">近6個月趨勢</span>
            </div>
            <div class="relative h-48"><canvas id="waterChart"></canvas></div>
            <div class="mt-4 border-t pt-4">
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-xs text-gray-500" id="waterLabel">本月產量</p>
                        <p class="text-2xl font-bold text-gray-800"><span id="waterValue">-</span> <span class="text-sm font-normal">噸</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500">YoY 成長率</p>
                        <p class="text-lg font-bold text-green-600 flex items-center justify-end" id="waterGrowth">-</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-cyan-700"><i class="fa-solid fa-database mr-2"></i> 儲水量比較</h2>
                <span class="bg-gray-100 text-gray-600 text-xs font-semibold px-2.5 py-0.5 rounded" id="storageRangeLabel">近期水位</span>
            </div>
            <div class="relative h-48"><canvas id="storageChart"></canvas></div>
            <div class="mt-4 border-t pt-4">
                <div class="flex justify-between items-start">
                    <div class="w-1/2">
                        <p class="text-xs text-gray-500">預測下月增減</p>
                        <p class="text-2xl font-bold text-gray-300" id="storageDiff">--</p> 
                        <p class="text-xs text-gray-400 mt-2">本月: <span id="storageCurrentVol" class="font-medium">-</span></p>
                    </div>
                    <div class="w-1/2 text-right">
                        <p class="text-xs text-gray-500">預測下月水位 (<span id="storageNextDate">--</span>)</p>
                        <p class="text-3xl font-bold text-purple-600 leading-tight">
                            <span id="storageNextVolume">--</span>
                            <span class="text-sm text-purple-500 font-medium">噸</span>
                        </p>
                        <p class="text-sm font-bold text-gray-600 mt-1"><span id="storageNextLevel">--</span> m</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-bold text-teal-700"><i class="fa-solid fa-microscope mr-2"></i> 水質導電率</h2>
                <span class="bg-teal-100 text-teal-800 text-xs font-semibold px-2.5 py-0.5 rounded">標準 < 100</span>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center"><div class="w-2 h-2 rounded-full bg-green-500 mr-3"></div><span class="text-sm font-medium">15000噸儲水槽</span></div>
                    <div class="flex items-center"><span class="text-base font-bold text-gray-800 mr-2" id="valTank">-</span><span class="text-xs text-gray-500">μS/cm</span></div>
                </div>
                 <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center"><div class="w-2 h-2 rounded-full bg-green-500 mr-3"></div><span class="text-sm font-medium">海淡機產水</span></div>
                    <div class="flex items-center"><span class="text-base font-bold text-gray-800 mr-2" id="valSea">-</span><span class="text-xs text-gray-500">μS/cm</span></div>
                </div>
                 <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center"><div class="w-2 h-2 rounded-full bg-green-500 mr-3"></div><span class="text-sm font-medium">RO 水</span></div>
                    <div class="flex items-center"><span class="text-base font-bold text-gray-800 mr-2" id="valRO">-</span><span class="text-xs text-gray-500">μS/cm</span></div>
                </div>
            </div>
            <div class="mt-4 pt-2 border-t text-center"><p class="text-xs text-green-600 font-medium"><i class="fa-solid fa-check-double mr-1"></i>全數符合水質標準</p></div>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-indigo-700"><i class="fa-solid fa-flask mr-2"></i> 尿素使用量</h2>
                <span class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-0.5 rounded">近6個月趨勢</span>
            </div>
            <div class="relative h-48"><canvas id="ureaChart"></canvas></div>
            <div class="mt-4 border-t pt-4">
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-xs text-gray-500" id="ureaLabel">本月用量</p>
                        <p class="text-2xl font-bold text-gray-800"><span id="ureaValue">-</span> <span class="text-sm font-normal">噸</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500">YoY 增加率</p>
                        <p class="text-lg font-bold text-red-500 flex items-center justify-end" id="ureaGrowth">-</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-orange-700"><i class="fa-solid fa-cloud-arrow-up mr-2"></i> CEMS NOx</h2>
                <span class="bg-orange-100 text-orange-800 text-xs font-semibold px-2.5 py-0.5 rounded">月累積平均</span>
            </div>
            <div class="mb-2"><span class="text-3xl font-bold text-gray-800"><span id="cemsValue">-</span> <span class="text-sm font-normal text-gray-500">ppm</span></span></div>
            
            <div class="relative w-full h-8 bg-gray-100 rounded-lg mt-6 mb-1">
                <div class="absolute top-0 bottom-0 border-l-2 border-dashed border-blue-500 z-20" id="cemsTargetLine" style="left: 0%"></div>
                <div class="absolute -top-6 text-xs font-bold text-blue-600 transform -translate-x-1/2 whitespace-nowrap" id="cemsTargetLabel" style="left: 0%">目標 247</div>
                
                <div class="absolute top-0 bottom-0 w-1 bg-red-500 z-20" id="cemsLimitLine" style="left: 0%"></div>
                <div class="absolute -top-6 text-xs font-bold text-red-600 transform -translate-x-1/2 whitespace-nowrap" id="cemsLimitLabel" style="left: 0%">上限 363</div>
                
                <div class="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-l-lg opacity-90" id="cemsBar" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-400 mt-1 mb-3"><span>0</span><span>400 ppm</span></div>
            <div class="space-y-2 mt-4 border-t pt-3">
                 <div class="flex items-start gap-2 text-sm text-gray-700"><i class="fa-solid fa-bullseye text-blue-500 mt-1"></i><p>環保局年度目標：<span class="font-bold">247 ppm</span></p></div>
                <div class="flex items-start gap-2 text-sm text-gray-700">
                    <i class="fa-solid fa-gavel text-red-500 mt-1"></i>
                    <div>
                        <p>空污許可證排放限制：<span class="font-bold">363 ppm</span></p>
                        <p class="text-xs text-gray-500 mt-0.5"><i class="fa-solid fa-triangle-exclamation mr-1"></i>每日不可超標超過 3 次</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-red-700"><i class="fa-solid fa-faucet-drip mr-2"></i> 放流水質及CWMS</h2>
                <span class="bg-red-100 text-red-800 text-xs font-semibold px-2.5 py-0.5 rounded">綜合監測</span>
            </div>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="font-medium text-gray-700">化學需氧量 (COD)</span>
                        <span class="text-gray-500"><span id="cwmsCODVal">-</span> / 100 mg/L</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" id="cwmsCODBar" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="font-medium text-gray-700">懸浮固體 (SS)</span>
                        <span class="text-gray-500"><span id="cwmsSSVal">-</span> / 30 mg/L</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" id="cwmsSSBar" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="font-medium text-gray-700">油脂 (Oil)</span>
                        <span class="text-gray-500"><span id="cwmsOilVal">-</span> / 10 mg/L</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" id="cwmsOilBar" style="width: 0%"></div>
                    </div>
                </div>
                 <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="font-medium text-gray-700">回收水每日平均流量</span>
                        <span class="text-gray-500"><span id="cwmsFlowVal">-</span> / 40 CMD</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-indigo-500 h-2 rounded-full" id="cwmsFlowBar" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="font-medium text-gray-700">D02未接觸冷卻水出口水溫</span>
                        <span class="text-gray-500"><span id="cwmsTempVal">-</span> / 42 °C</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" id="cwmsTempBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-3 border-t flex items-center justify-center">
                 <span class="text-xs font-bold text-green-600 bg-green-100 px-3 py-1 rounded-full border border-green-200">
                    <i class="fa-solid fa-check-double mr-1"></i>符合排放標準
                </span>
            </div>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow-sm md:col-span-2 lg:col-span-3">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-purple-700"><i class="fa-solid fa-calendar-days mr-2"></i> 重點行程與業務規劃</h2>
            </div>
            <div class="flex flex-col gap-0">
                 <div class="flex items-center py-4 border-b border-gray-100 last:border-0">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-100 text-purple-700 flex items-center justify-center font-bold text-lg mr-4">1</div>
                    <div class="flex-grow flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-4">
                        <h4 class="font-bold text-lg text-gray-800" id="schedTitle1">-</h4>
                        <span class="text-base text-gray-500" id="schedDesc1">-</span>
                    </div>
                </div>
                <div class="flex items-center py-4 border-b border-gray-100 last:border-0">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-100 text-purple-700 flex items-center justify-center font-bold text-lg mr-4">2</div>
                    <div class="flex-grow flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-4">
                        <h4 class="font-bold text-lg text-gray-800" id="schedTitle2">-</h4>
                        <span class="text-base text-gray-500" id="schedDesc2">-</span>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <footer class="mt-8 text-center text-gray-400 text-xs no-print">
        <p>台電尖山發電廠 - 環化課 | Data Source: Google Sheets</p>
    </footer>

    <script>
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBqhzNkZ_EJSSxTKhdf038RbZ0vc7_4C84ACXoUj4Dtnu9MBaK0nq9IFaMPcY7ixfc_FZK5Kz9SG3u/pub?output=csv";
        
        let allRecords = [];
        let charts = {};

        async function initDashboard() {
            try {
                const rawData = await fetchData(GOOGLE_SHEET_CSV_URL);
                if (!rawData || rawData.length < 10) throw new Error("資料讀取異常");

                allRecords = parseCSV(rawData);
                populateSelectors();

                if(allRecords.length > 0) {
                    const latest = allRecords[allRecords.length - 1];
                    document.getElementById('selYear').value = latest.year;
                    document.getElementById('selMonth').value = latest.month;
                    updateViewFromSelector();
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboardContent').style.opacity = '1';
                
            } catch (error) {
                console.error(error);
                alert("發生錯誤：" + error.message);
            }
        }

        async function fetchData(url) {
            const response = await fetch(url);
            return await response.text();
        }

        function parseCSV(csvText) {
            const rows = csvText.split('\n').map(row => row.split(','));
            const data = [];
            
            for (let i = 5; i < rows.length; i++) {
                const col = rows[i];
                if (!col[0]) continue; 

                const year = parseInt(col[0].trim());
                const month = parseInt(col[1].trim());
                const sortKey = year * 100 + month;

                const record = {
                    sortKey: sortKey,
                    year: year, 
                    month: month,
                    water: parseFloat(col[4]) || 0,
                    level: parseFloat(col[7]) || 0,
                    volume: parseFloat(col[8]) || 0,
                    condTank: parseFloat(col[9]) || 0,
                    condSea: parseFloat(col[11]) || 0,
                    condRO: parseFloat(col[12]) || 0,
                    urea: parseFloat(col[16]) || 0,
                    cems: parseFloat(col[21]) || 0,
                    temp: parseFloat(col[23]) || 0,
                    cwmsFlow: parseFloat(col[25]) || 0,
                    cwmsSS: parseFloat(col[26]) || 0,
                    cwmsCOD: parseFloat(col[27]) || 0,
                    cwmsOil: parseFloat(col[28]) || 0,
                    schedTitle1: col[29] ? col[29].trim() : "",
                    schedDesc1:  col[30] ? col[30].trim() : "",
                    schedTitle2: col[31] ? col[31].trim() : "",
                    schedDesc2:  col[32] ? col[32].trim() : ""
                };
                data.push(record);
            }
            return data.sort((a, b) => a.sortKey - b.sortKey);
        }

        function populateSelectors() {
            const yearSet = new Set();
            allRecords.forEach(r => yearSet.add(r.year));
            const years = Array.from(yearSet).sort((a,b) => b-a);

            const selYear = document.getElementById('selYear');
            selYear.innerHTML = '';
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y + "年";
                selYear.appendChild(opt);
            });

            const selMonth = document.getElementById('selMonth');
            selMonth.innerHTML = '';
            for(let m=1; m<=12; m++) {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m + "月";
                selMonth.appendChild(opt);
            }
        }

        function updateViewFromSelector() {
            const y = parseInt(document.getElementById('selYear').value);
            const m = parseInt(document.getElementById('selMonth').value);
            
            const targetIndex = allRecords.findIndex(r => r.year === y && r.month === m);
            if (targetIndex === -1) {
                alert(`查無 ${y}年${m}月 的資料！`);
                return;
            }

            const currentRecord = allRecords[targetIndex];
            // 抓取下一筆資料 (如果有的話)
            const nextRecord = (targetIndex < allRecords.length - 1) ? allRecords[targetIndex + 1] : null;

            updateTextData(currentRecord, nextRecord);

            const range6Months = getSlice(targetIndex, 5, 0); 
            const rangeStorage = getSlice(targetIndex, 5, 1);

            const lastYearData = range6Months.map(curr => {
                const match = allRecords.find(r => r.year === (curr.year - 1) && r.month === curr.month);
                return match ? match : { water: 0, urea: 0, year: curr.year-1, month: curr.month }; 
            });

            drawWaterChart(range6Months, lastYearData);
            drawUreaChart(range6Months, lastYearData);
            drawStorageChart(rangeStorage, currentRecord);
        }

        function getSlice(currentIndex, lookback, lookforward) {
            const start = Math.max(0, currentIndex - lookback);
            const end = Math.min(allRecords.length, currentIndex + lookforward + 1);
            return allRecords.slice(start, end);
        }

        function updateTextData(curr, next) {
            // Header
            document.getElementById('headerSubtitle').textContent = `報告人：高振凱 課長 | 數據基準：${curr.year}年${curr.month}月`;

            // Water Text
            document.getElementById('waterLabel').textContent = `${curr.year}年${curr.month}月產量`;
            document.getElementById('waterValue').textContent = curr.water.toLocaleString();
            const lastYearMatch = allRecords.find(r => r.year === (curr.year - 1) && r.month === curr.month);
            if(lastYearMatch && lastYearMatch.water > 0) {
                const growth = ((curr.water - lastYearMatch.water) / lastYearMatch.water * 100).toFixed(1);
                const colorClass = growth >= 0 ? 'text-green-600' : 'text-red-600';
                const icon = growth >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                document.getElementById('waterGrowth').className = `text-lg font-bold flex items-center justify-end ${colorClass}`;
                document.getElementById('waterGrowth').innerHTML = `<i class="fa-solid ${icon} mr-1"></i> ${growth}%`;
            } else {
                document.getElementById('waterGrowth').innerHTML = `<span class="text-gray-400 text-sm">無去年資料</span>`;
            }

            // Storage Text (Logic Updated)
            document.getElementById('storageRangeLabel').textContent = `本月 vs 下月`;
            document.getElementById('storageCurrentVol').textContent = curr.volume.toLocaleString() + ' 噸';
            
            if (next) {
                document.getElementById('storageNextDate').textContent = `${next.month}月`;
                document.getElementById('storageNextVolume').textContent = next.volume.toLocaleString();
                document.getElementById('storageNextLevel').textContent = next.level;

                const volDiff = next.volume - curr.volume;
                const diffEl = document.getElementById('storageDiff');
                if (volDiff < 0) {
                    diffEl.innerHTML = `<i class="fa-solid fa-arrow-down mr-1"></i> ${Math.abs(volDiff).toLocaleString()}`;
                    diffEl.className = "text-2xl font-bold text-orange-600";
                } else {
                    diffEl.innerHTML = `<i class="fa-solid fa-arrow-up mr-1"></i> ${volDiff.toLocaleString()}`;
                    diffEl.className = "text-2xl font-bold text-blue-600";
                }
            } else {
                document.getElementById('storageNextDate').textContent = "下月";
                document.getElementById('storageNextVolume').textContent = "待輸入";
                document.getElementById('storageNextLevel').textContent = "-";
                document.getElementById('storageDiff').textContent = "--";
                document.getElementById('storageDiff').className = "text-2xl font-bold text-gray-300";
            }

            // Conductivity
            document.getElementById('valTank').textContent = curr.condTank;
            document.getElementById('valSea').textContent = curr.condSea;
            document.getElementById('valRO').textContent = curr.condRO;

            // Urea Text
            document.getElementById('ureaLabel').textContent = `${curr.year}年${curr.month}月用量`;
            document.getElementById('ureaValue').textContent = curr.urea;
            const lastYearUrea = allRecords.find(r => r.year === (curr.year - 1) && r.month === curr.month);
            if(lastYearUrea && lastYearUrea.urea > 0) {
                const uGrowth = ((curr.urea - lastYearUrea.urea) / lastYearUrea.urea * 100).toFixed(1);
                const colorClass = uGrowth >= 0 ? 'text-red-500' : 'text-green-600';
                document.getElementById('ureaGrowth').className = `text-lg font-bold flex items-center justify-end ${colorClass}`;
                document.getElementById('ureaGrowth').innerHTML = `<i class="fa-solid fa-arrow-up mr-1"></i> ${uGrowth}%`;
            } else {
                document.getElementById('ureaGrowth').innerHTML = `<span class="text-gray-400 text-sm">無去年資料</span>`;
            }

            // CEMS & CWMS
            document.getElementById('cemsValue').textContent = curr.cems;
            document.getElementById('cemsBar').style.width = `${(curr.cems / 400) * 100}%`;
            
            const limits = { cod: 100, ss: 30, oil: 10, flow: 40, temp: 42 };
            document.getElementById('cwmsCODVal').textContent = curr.cwmsCOD;
            document.getElementById('cwmsCODBar').style.width = `${Math.min((curr.cwmsCOD / limits.cod) * 100, 100)}%`;
            document.getElementById('cwmsSSVal').textContent = curr.cwmsSS;
            document.getElementById('cwmsSSBar').style.width = `${Math.min((curr.cwmsSS / limits.ss) * 100, 100)}%`;
            document.getElementById('cwmsOilVal').textContent = curr.cwmsOil;
            document.getElementById('cwmsOilBar').style.width = `${Math.min((curr.cwmsOil / limits.oil) * 100, 100)}%`;
            document.getElementById('cwmsFlowVal').textContent = curr.cwmsFlow;
            document.getElementById('cwmsFlowBar').style.width = `${Math.min((curr.cwmsFlow / limits.flow) * 100, 100)}%`;
            document.getElementById('cwmsTempVal').textContent = curr.temp;
            document.getElementById('cwmsTempBar').style.width = `${Math.min((curr.temp / limits.temp) * 100, 100)}%`;

            // Schedule
            document.getElementById('schedTitle1').textContent = curr.schedTitle1;
            document.getElementById('schedDesc1').textContent = curr.schedDesc1;
            document.getElementById('schedTitle2').textContent = curr.schedTitle2;
            document.getElementById('schedDesc2').textContent = curr.schedDesc2;
        }

        function drawWaterChart(dataCurr, dataPrev) {
            const ctx = document.getElementById('waterChart').getContext('2d');
            if(charts['water']) charts['water'].destroy();

            const labels = dataCurr.map(d => `${d.month}月`);

            charts['water'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '去年同期',
                            data: dataPrev.map(d => d.water),
                            backgroundColor: '#e2e8f0',
                            order: 2,
                            barPercentage: 0.6,
                            categoryPercentage: 0.8
                        },
                        {
                            label: '今年',
                            data: dataCurr.map(d => d.water),
                            backgroundColor: '#3b82f6',
                            order: 1,
                            barPercentage: 0.6,
                            categoryPercentage: 0.8
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: true, align: 'end' },
                        tooltip: { callbacks: { label: (c) => c.dataset.label + ': ' + c.raw.toLocaleString() + ' 噸' } }
                    },
                    scales: { y: { display: false }, x: { grid: { display: false } } }
                }
            });
        }

        function drawUreaChart(dataCurr, dataPrev) {
            const ctx = document.getElementById('ureaChart').getContext('2d');
            if(charts['urea']) charts['urea'].destroy();

            const labels = dataCurr.map(d => `${d.month}月`);

            charts['urea'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '去年同期',
                            data: dataPrev.map(d => d.urea),
                            backgroundColor: '#94a3b8',
                            order: 2,
                            barPercentage: 0.6,
                            categoryPercentage: 0.8
                        },
                        {
                            label: '今年',
                            data: dataCurr.map(d => d.urea),
                            backgroundColor: '#6366f1',
                            order: 1,
                            barPercentage: 0.6,
                            categoryPercentage: 0.8
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: true, align: 'end' },
                        tooltip: { callbacks: { label: (c) => c.dataset.label + ': ' + c.raw.toLocaleString() + ' 噸' } }
                    },
                    scales: { y: { display: false }, x: { grid: { display: false } } }
                }
            });
        }

        function drawStorageChart(rangeData, currentRecord) {
            const ctx = document.getElementById('storageChart').getContext('2d');
            if(charts['storage']) charts['storage'].destroy();

            const labels = rangeData.map(d => `${d.month}月`);
            const data = rangeData.map(d => d.volume);

            const bgColors = rangeData.map(d => {
                if (d.year === currentRecord.year && d.month === currentRecord.month) return '#06b6d4'; 
                if (d.sortKey > currentRecord.sortKey) return '#a5f3fc'; 
                return '#94a3b8'; 
            });

            charts['storage'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '儲水量',
                        data: data,
                        backgroundColor: bgColors,
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (c) => c.raw.toLocaleString() + ' 噸' } }
                    },
                    scales: { y: { display: false }, x: { grid: { display: false } } }
                }
            });
        }

        window.addEventListener('DOMContentLoaded', initDashboard);

    </script>
</body>
</html>
