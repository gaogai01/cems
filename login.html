<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登入系統 - 尖山發電廠</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h1 { color: #2c3e50; margin-bottom: 1.5rem; font-size: 1.5rem; }
        input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        button { width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: 0.3s; }
        .btn-google { background: #db4437; color: white; } .btn-google:hover { background: #c53929; }
        .btn-submit { background: #007bff; color: white; } .btn-submit:hover { background: #0056b3; }
        .btn-logout { background: #6c757d; color: white; margin-top: 20px; }
        .hidden { display: none; }
        .status-msg { margin: 20px 0; padding: 10px; background: #fff3cd; color: #856404; border-radius: 5px; }
        
        /* 管理員列表 */
        #admin-panel { text-align: left; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .approve-btn { width: auto; padding: 5px 10px; background: #28a745; color: white; font-size: 0.8rem; margin: 0; }
    </style>
</head>
<body>

<div class="card">
    <h1>尖山發電廠監控系統</h1>
    
    <div id="login-view">
        <button class="btn-google" onclick="loginWithGoogle()">使用 Google 帳號登入</button>
    </div>

    <div id="register-view" class="hidden">
        <h3>初次登入請填寫資料</h3>
        <input type="text" id="reg-name" placeholder="姓名 (例如：王大明)">
        <input type="text" id="reg-dept" placeholder="部門 (例如：環保課)">
        <button class="btn-submit" onclick="submitReg()">送出審核</button>
    </div>

    <div id="pending-view" class="hidden">
        <div class="status-msg">⏳ 帳號審核中...<br>請通知管理員開通權限</div>
        <button class="btn-logout" onclick="logout()">登出</button>
    </div>

    <div id="admin-view" class="hidden">
        <h3>管理員後台</h3>
        <p>您已核准進入系統。</p>
        <button class="btn-submit" onclick="location.href='index.html'">前往 廢油水監控</button>
        <button class="btn-submit" style="background:#6f42c1" onclick="location.href='cems.html'">前往 CEMS 監測</button>
        
        <div id="admin-panel">
            <h4>待審核名單</h4>
            <div id="user-list">載入中...</div>
        </div>
        <button class="btn-logout" onclick="logout()">登出</button>
    </div>
</div>

<script>
    // ▼▼▼ 請在此貼上您的 Firebase Config ▼▼▼
    const firebaseConfig = {
  apiKey: "AIzaSyA58DOYplXhmo7HDYN_2Hgu-wo4ceYmINA",
  authDomain: "tpc-monitor.firebaseapp.com",
  projectId: "tpc-monitor",
  storageBucket: "tpc-monitor.firebasestorage.app",
  messagingSenderId: "1066125366380",
  appId: "1:1066125366380:web:836d5898c051226669f449"
    };
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(async (user) => {
        document.querySelectorAll('.card > div').forEach(el => el.classList.add('hidden'));
        
        if (user) {
            const doc = await db.collection('users').doc(user.uid).get();
            if (!doc.exists) {
                document.getElementById('register-view').classList.remove('hidden');
            } else {
                const data = doc.data();
                if (data.isApproved) {
                    // 如果不是管理員，直接跳轉到廢水首頁
                    if (!data.isAdmin) {
                        location.href = 'index.html'; 
                    } else {
                        // 管理員留在這裡審核人
                        document.getElementById('admin-view').classList.remove('hidden');
                        loadUserList();
                    }
                } else {
                    document.getElementById('pending-view').classList.remove('hidden');
                }
            }
        } else {
            document.getElementById('login-view').classList.remove('hidden');
        }
    });

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => alert(e.message));
    }

    function submitReg() {
        const user = auth.currentUser;
        const name = document.getElementById('reg-name').value;
        const dept = document.getElementById('reg-dept').value;
        if(!name || !dept) return alert("請填寫完整");
        
        db.collection('users').doc(user.uid).set({
            name, dept, email: user.email, isApproved: false, isAdmin: false, createdAt: new Date()
        }).then(() => location.reload());
    }

    function logout() { auth.signOut(); }

    // 管理員功能
    async function loadUserList() {
        const listDiv = document.getElementById('user-list');
        const snap = await db.collection('users').orderBy('createdAt', 'desc').get();
        let html = '';
        snap.forEach(doc => {
            const u = doc.data();
            if (!u.isApproved) { // 只顯示未核准的
                html += `
                <div class="user-item">
                    <div><b>${u.name}</b> (${u.dept})</div>
                    <button class="approve-btn" onclick="approveUser('${doc.id}')">核准</button>
                </div>`;
            }
        });
        listDiv.innerHTML = html || '目前無待審核人員';
    }

    function approveUser(uid) {
        db.collection('users').doc(uid).update({ isApproved: true }).then(() => loadUserList());
    }
</script>
</body>
</html>
