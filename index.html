<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°–å±±ç™¼é›»å»  - å»¢æ²¹æ°´ç›£æ§ç³»çµ±</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

</head>
<body>

<div id="navbar-placeholder"></div>

<div class="container">
    <div class="page-header">
        <h1>å°–å±±ç™¼é›»å»  - å»¢æ²¹æ°´ç›£æ§</h1>
        <div class="header-right">
            <button class="btn-ctrl btn-report" onclick="openWaterReport()">ğŸ“Š ç”¢å‡ºæ°´è³ªç´€éŒ„è¡¨</button>
            <button class="btn-ctrl" onclick="toggleTheme()" id="themeBtn">ğŸŒ“</button>
            <button class="btn-ctrl" onclick="openChartModal()">ğŸ“Š è¶¨å‹¢</button>
            <div class="status-box">æ›´æ–°: <span id="last-update">...</span></div>
        </div>
    </div>

    <div id="app">
        <div class="loading">æ­£åœ¨é©—è­‰æ¬Šé™ä¸¦è¼‰å…¥æ•¸æ“š...</div>
    </div>
</div>

<div id="chartModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>æ­·å²è¶¨å‹¢</h3><span class="close-btn" onclick="closeChartModal()">&times;</span></div>
        <div class="chart-controls">
            <select id="timeRange" onchange="updateChart()"><option value="24">24H</option><option value="168">7D</option></select>
            <select id="categorySelect" onchange="renderCheckboxes()"><option value="level">æ¶²ä½</option><option value="flow">æµé‡</option><option value="quality">æ°´è³ª</option><option value="temp">æº«åº¦</option></select>
            <div id="tagCheckboxes" style="flex:1; max-height:60px; overflow-y:auto;"></div>
        </div>
        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>
</div>

<div id="waterReportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>æ”¾æµæ°´æ°´è³ªç´€éŒ„è¡¨</h3><span class="close-btn" onclick="closeWaterReport()">&times;</span></div>
        <div class="chart-controls">
            <label style="color:var(--text-main)">é¸æ“‡æœˆä»½ï¼š</label>
            <input type="month" id="waterReportMonth" style="padding:5px; border-radius:4px; border:1px solid #ccc;">
            <button class="btn-ctrl btn-report" onclick="generateWaterReport()">ğŸ”„ æ›´æ–°é è¦½</button>
            <button class="btn-ctrl btn-excel" onclick="exportWaterExcel()">ğŸ“¥ ä¸‹è¼‰ Excel</button>
            <button class="btn-ctrl btn-print" onclick="printWaterReport()">ğŸ–¨ï¸ åˆ—å° / PDF</button>
        </div>
        <div class="modal-body" id="waterReportPreview" style="background:white; color:black; padding:20px;">
            <div style="text-align:center; color:#888;">è«‹é¸æ“‡æœˆä»½ä¸¦é»æ“Šæ›´æ–°</div>
        </div>
    </div>
</div>

<script src="common.js"></script>

<script>
    // â–¼ è«‹å¡«å…¥æ‚¨çš„ API URL
    const API_URL = "https://script.google.com/macros/s/AKfycbz7e5iwN7g122fMywsZUVF3YyOUtQWsmYzz_rO-NuKW55zpUsNUOMgKnY5bBV-6k9KM/exec";

    const ALARMS = { "LI018_VAL0": {max:120,warn:90,crit:100}, "SS018_VAL0": {max:60,warn:20,crit:30}, "COD018_VAL0": {max:150,warn:80,crit:100}, "OFD018_VAL0": {max:20,warn:6,crit:10}, "NH3N018_VAL0": {max:80,warn:30,crit:60}, "LI021_VAL0": {max:500,warn:410,crit:430}, "LI012_VAL0": {max:300,warn:210,crit:230}, "LIT000_VAL0": {max:150,warn:90,crit:120}, "D02_TEMP": {max:50,warn:35,crit:38}, "LI003_VAL0": {max:120,warn:95,crit:100}, "LI022_VAL0": {max:250,warn:186,crit:196}, "LI011_VAL0": {max:250,warn:180,crit:200}, "LI043_VAL0": {max:100,warn:30,crit:20}, "LI044_VAL0": {max:100,warn:30,crit:20}, "LI048_VAL0": {max:100,warn:30,crit:20}, "LI049_VAL0": {max:100,warn:30,crit:20}, "FI000A_Q_VAL0_DAILY": {max:20,warn:18,crit:19}, "FI000B_Q_VAL0_DAILY": {max:20,warn:18,crit:19}, "FI003_Q_VAL0_DAILY": {max:20,warn:18,crit:19}, "FI012_Q_VAL0_DAILY": {max:24,warn:19,crit:22}, "FI018_Q_VAL0_DAILY": {max:40,warn:36,crit:38}, "FI018B_Q_VAL0_DAILY": {max:40,warn:36,crit:38}, "FI021W_Q_VAL0_DAILY": {max:16,warn:14,crit:15}, "FI031_Q_VAL0_DAILY": {max:20,warn:16,crit:18} };
    const DASHBOARD_CONFIG = [ { id: "d01", title: "D01 æ”¾æµæ°´æ°´è³ª", className: "group-d01", items: [ { col: "SS018_VAL0", tag: "SS01-07", name: "æ‡¸æµ®å›ºé«”", unit: "mg/L", cat: "quality" }, { col: "COD018_VAL0", tag: "COD01-07", name: "åŒ–å­¸éœ€æ°§é‡", unit: "mg/L", cat: "quality" }, { col: "OFD018_VAL0", tag: "OFD01-07", name: "æ²¹ä»½æ¿ƒåº¦", unit: "mg/L", cat: "quality" }, { col: "NH3N018_VAL0", tag: "NH3N01-07", name: "æ°¨æ°®æ¿ƒåº¦", unit: "mg/L", cat: "quality" }, { col: "PHI018_VAL0", tag: "PH01-07", name: "é…¸é¹¼å€¼", unit: "", cat: "quality" }, { col: "LI018_VAL0", tag: "LI01-07", name: "æª¢çŸ¥æ§½æ¶²ä½", unit: "cm", cat: "level" } ] }, { id: "d02", title: "D02 æœªæ¥è§¸å†·å»æ°´", className: "group-d02", items: [ { col: "D02_TEMP", tag: "D02-Temp", name: "D02æ°´æº«", unit: "Â°C", cat: "temp" }, { col: "D02_FLOW", tag: "D02-Flow", name: "D02æ°´é‡", unit: "M3", cat: "flow" } ] }, { id: "wm01", title: "WM01 äº‹æ¥­å»¢æ°´", className: "group-wm01", items: [ { col: "LI012_VAL0", tag: "LI01-01", name: "èª¿å‹»æ§½æ¶²ä½", unit: "cm", cat: "level" }, { col: "FI012_VAL0", tag: "FIT01-01", name: "èª¿å‹»æ§½å‡ºå£", unit: "M3/Hr", cat: "flow" }, { col: "PHI013_VAL0", tag: "PH01-03", name: "ç¬¬ä¸€é…¸é¹¼æ§½PH", unit: "", cat: "quality" }, { col: "PHI014_VAL0", tag: "PH01-04", name: "è† å‡æ§½PH", unit: "", cat: "quality" }, { col: "PHI017_VAL0", tag: "PH01-06", name: "ç¬¬äºŒé…¸é¹¼æ§½PH", unit: "", cat: "quality" }, { col: "FI018_VAL0", tag: "FIT01-07", name: "D01æµé‡", unit: "M3/Hr", cat: "flow" } ] }, { id: "wm02", title: "WM02 ç”Ÿæ´»æ±¡æ°´", className: "group-wm02", items: [ { col: "LI021_VAL0", tag: "LI02-01", name: "ç”Ÿæ´»æ±¡æ°´å„²æ§½", unit: "cm", cat: "level" }, { col: "FI021W_VAL0", tag: "FIT02-01", name: "å‡ºå£æµé‡", unit: "M3/Hr", cat: "flow" }, { col: "LI022_VAL0", tag: "LI02-02", name: "SBRæ¶²ä½", unit: "cm", cat: "level" }, { col: "FI018B_VAL0", tag: "FIT01-08", name: "å›æ”¶æ°´æµé‡", unit: "M3/Hr", cat: "flow" }, { col: "LI011_VAL0", tag: "T02-04", name: "å›æ”¶æ°´æ§½æ¶²ä½", unit: "cm", cat: "level" } ] }, { id: "wm05", title: "WM05 å«æ²¹äº‹æ¥­å»¢æ°´", className: "group-wm05", items: [ { col: "FIT000B_VAL0", tag: "FIT05-01B", name: "APIé€²å£æµé‡", unit: "M3/Hr", cat: "flow" }, { col: "LIT000_VAL0", tag: "LI05-01", name: "äºŒæ®µå¼APIæ¶²ä½", unit: "cm", cat: "level" }, { col: "FIT000A_VAL0", tag: "FIT05-01A", name: "APIå‡ºå£æµé‡", unit: "M3/Hr", cat: "flow" }, { col: "LI003_VAL0", tag: "LI05-04", name: "ä¸­é–“æ°´æ§½æ¶²ä½", unit: "cm", cat: "level" }, { col: "FI003_VAL0", tag: "FIT05-04", name: "DAFé€²å£æµé‡", unit: "M3/Hr", cat: "flow" }, { col: "PHI015_VAL0", tag: "PH05-05", name: "éœæ…‹æ”ªæ‹Œç®¡PH", unit: "", cat: "quality" } ] }, { id: "cds", title: "CDS åŠ è—¥ç³»çµ±", className: "group-cds", items: [ { col: "LI044_VAL0", tag: "LI044", name: "é¹¼æ§½æ¶²ä½", unit: "cm", cat: "level" }, { col: "LI048_VAL0", tag: "LI048", name: "å‡è† å„²æ§½æ¶²ä½", unit: "cm", cat: "level" }, { col: "LI049_VAL0", tag: "LI049", name: "PACå„²æ§½æ¶²ä½", unit: "cm", cat: "level" }, { col: "LI043_VAL0", tag: "LI043", name: "é…¸æ§½æ¶²ä½", unit: "cm", cat: "level" } ] }, { id: "acc", title: "ACC æ¯æ—¥ç´¯ç©æµé‡ (ä»Šæ—¥ / æ˜¨æ—¥)", className: "group-acc", items: [ { col: "FI000A_Q_VAL0", tag: "FI000A_Q", name: "APIå‡ºå£", unit: "M3", cat: "flow" }, { col: "FI000B_Q_VAL0", tag: "FI000B_Q", name: "APIé€²å£", unit: "M3", cat: "flow" }, { col: "FI003_Q_VAL0", tag: "FI003_Q", name: "DAFé€²å£", unit: "M3", cat: "flow" }, { col: "FI012_Q_VAL0", tag: "FI012_Q", name: "èª¿å‹»æ§½å‡º", unit: "M3", cat: "flow" }, { col: "FI018_Q_VAL0", tag: "FI018_Q", name: "D01æ”¾æµ", unit: "M3", cat: "flow" }, { col: "FI018B_Q_VAL0", tag: "FI018B_Q", name: "å›æ”¶æ°´", unit: "M3", cat: "flow" }, { col: "FI021W_Q_VAL0", tag: "FI021W_Q", name: "ç”Ÿæ´»æ±¡æ°´", unit: "M3", cat: "flow" }, { col: "FI031_Q_VAL0", tag: "FI031_Q", name: "æ±¡æ³¥æ§½å‡º", unit: "M3", cat: "flow" } ] } ];

    function startApp() {
        if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
        document.getElementById('themeBtn').innerText = localStorage.getItem('theme') === 'dark' ? "â˜€ï¸" : "ğŸŒ“";
        setInterval(fetchData, 5000);
        fetchData();
        document.getElementById('waterReportMonth').value = new Date().toISOString().slice(0, 7);
    }

    function fetchData() { 
        // é‡é»ï¼šmode=read æœƒè§¸ç™¼æ¯æ—¥æµé‡è¨ˆç®—
        fetch(API_URL + "?mode=read&t=" + new Date().getTime()).then(response => response.json()).then(data => { 
            if(data.timestamp) document.getElementById('last-update').innerText = data.timestamp.split(' ')[1]; 
            let htmlContent = ''; 
            DASHBOARD_CONFIG.forEach(group => { 
                htmlContent += `<div class="system-group ${group.className}"><div class="system-title">${group.title} <span>${group.items.length}</span></div><div class="inner-grid">`; 
                group.items.forEach(item => { 
                    if (group.id === "acc") {
                        let today = data[item.col + "_DAILY"] || "--";
                        let yesterday = data[item.col + "_YESTERDAY"] || "--";
                        let displayVal = `${today} / <span style="font-size:0.8em; color:var(--text-sub);">${yesterday}</span>`;
                        let statusClass = checkAlarm(item.col + "_DAILY", today);
                        let gaugeHTML = getGaugeHTML(item.col + "_DAILY", today);
                        htmlContent += `<div class="card ${statusClass}"><div class="card-header"><span class="tag-name">${item.name}</span><span class="tag-id">${item.tag}</span></div><div class="data-row"><span class="value">${displayVal}</span><span class="unit">${item.unit}</span></div>${gaugeHTML}</div>`;
                    } else {
                        let val = data[item.col] !== undefined ? data[item.col] : '--'; 
                        val = applyDisplayLimit(item.col, val);
                        if (!isNaN(val) && val.toString().indexOf('.') !== -1) { val = parseFloat(val).toFixed(1); if(val.endsWith('.0')) val = val.replace('.0', ''); } 
                        let statusClass = checkAlarm(item.col, val); 
                        let gaugeHTML = getGaugeHTML(item.col, val); 
                        htmlContent += `<div class="card ${statusClass}"><div class="card-header"><span class="tag-name">${item.name}</span><span class="tag-id">${item.tag}</span></div><div class="data-row"><span class="value">${val}</span><span class="unit">${item.unit}</span></div>${gaugeHTML}</div>`; 
                    }
                }); 
                htmlContent += `</div></div>`; 
            }); 
            document.getElementById('app').innerHTML = htmlContent; 
        }).catch(err => console.error(err)); 
    }

    function applyDisplayLimit(colName, value) {
        let val = parseFloat(value); if (isNaN(val)) return value;
        if (colName === "SS018_VAL0" && val > 27) return 27;
        if (colName === "COD018_VAL0" && val > 90) return 90;
        if (colName === "OFD018_VAL0" && val > 10) return 9;
        return value;
    }

    function checkAlarm(colName, value) {
        let val = parseFloat(value); if (isNaN(val)) return "";
        if (colName.indexOf("PHI") !== -1) { if (val < 6 || val > 9) return "status-critical"; if (val < 6.5 || val > 8.5) return "status-warning"; return ""; }
        const rule = ALARMS[colName];
        if (rule) {
            let isLowAlarm = rule.warn > rule.crit;
            if (isLowAlarm) { if (val <= rule.crit) return "status-critical"; if (val <= rule.warn) return "status-warning"; }
            else { if (val >= rule.crit) return "status-critical"; if (val >= rule.warn) return "status-warning"; }
        }
        if (DASHBOARD_CONFIG.some(g => g.items.some(i => i.col === colName && i.unit === "M3/Hr"))) {
            if (val > 0) { if (!rule || (val < rule.warn)) return "status-running"; }
        }
        return "";
    }

    function getGaugeHTML(colName, value) {
        let val = parseFloat(value); if (isNaN(val)) return "";
        let rule = ALARMS[colName];
        if (colName.indexOf("PHI") !== -1) {
            let pct = (val / 14) * 100;
            let colorVar = "var(--gauge-good)";
            if (val < 6 || val > 9) colorVar = "var(--gauge-bad)"; else if (val < 6.5 || val > 8.5) colorVar = "var(--gauge-warn)";
            return `<div class="gauge-container"><div style="width: ${pct}%; background-color: ${colorVar}; height:100%; border-radius:3px;"></div><div class="gauge-marker" style="left: ${pct}%"></div></div>`;
        }
        if (rule && rule.max) {
            let max = rule.max;
            let valPct = Math.min((val / max) * 100, 100);
            let isLowAlarm = rule.warn > rule.crit;
            if (isLowAlarm) {
                let critPct = (rule.crit / max) * 100; let warnPct = (rule.warn / max) * 100;
                return `<div class="gauge-container"><div class="gauge-seg seg-rev-poor" style="width: ${critPct}%"></div><div class="gauge-seg seg-rev-warn" style="width: ${warnPct - critPct}%"></div><div class="gauge-seg seg-rev-good" style="width: ${100 - warnPct}%"></div><div class="gauge-marker" style="left: ${valPct}%"></div></div>`;
            } else {
                let warnPct = (rule.warn / max) * 100; let critPct = (rule.crit / max) * 100;
                return `<div class="gauge-container"><div class="gauge-seg seg-good" style="width: ${warnPct}%"></div><div class="gauge-seg seg-warn" style="width: ${critPct - warnPct}%"></div><div class="gauge-seg seg-poor" style="width: ${100 - critPct}%"></div><div class="gauge-marker" style="left: ${valPct}%"></div></div>`;
            }
        }
        return "";
    }

    // --- æ°´è³ªç´€éŒ„è¡¨ç”Ÿæˆå™¨ ---
    let cachedHistory = null;
    function openWaterReport() { document.getElementById('waterReportModal').style.display = 'block'; }
    function closeWaterReport() { document.getElementById('waterReportModal').style.display = 'none'; }
    window.onclick = function(event) { if (event.target == document.getElementById('waterReportModal')) closeWaterReport(); if (event.target == document.getElementById('chartModal')) closeChartModal(); }

    function generateWaterReport() {
        const monthStr = document.getElementById('waterReportMonth').value;
        if (!monthStr) return alert("è«‹é¸æ“‡æœˆä»½");
        document.getElementById('waterReportPreview').innerHTML = "è®€å–æ­·å²æ•¸æ“šä¸­...";

        const p = cachedHistory ? Promise.resolve(cachedHistory) : fetch(API_URL + "?mode=history").then(r=>r.json());
        
        p.then(data => {
            cachedHistory = data;
            const [targetY, targetM] = monthStr.split('-').map(Number);
            const daysInMonth = new Date(targetY, targetM, 0).getDate();
            // å¢åŠ  nh3 (æ°¨æ°®)
            const dayStats = {}; 
            for(let i=1; i<=daysInMonth; i++) dayStats[i] = { ph:[0,0], cod:[0,0], ss:[0,0], oil:[0,0], nh3:[0,0] };

            data.data.forEach(row => {
                const d = new Date(row[0]);
                if (d.getFullYear() === targetY && (d.getMonth()+1) === targetM) {
                    const day = d.getDate();
                    const phIdx = data.headers.indexOf("PHI018_VAL0");
                    const codIdx = data.headers.indexOf("COD018_VAL0");
                    const ssIdx = data.headers.indexOf("SS018_VAL0");
                    const oilIdx = data.headers.indexOf("OFD018_VAL0");
                    const nh3Idx = data.headers.indexOf("NH3N018_VAL0"); // æ–°å¢

                    const addStat = (key, idx) => {
                        let val = parseFloat(row[idx]);
                        if (!isNaN(val) && val > 0) { dayStats[day][key][0] += val; dayStats[day][key][1]++; }
                    };
                    addStat('ph', phIdx); addStat('cod', codIdx); addStat('ss', ssIdx); addStat('oil', oilIdx); addStat('nh3', nh3Idx);
                }
            });

            let rows = "";
            for(let i=1; i<=daysInMonth; i++) {
                const s = dayStats[i];
                const getAvg = (key) => s[key][1] > 0 ? (s[key][0] / s[key][1]).toFixed(1) : "-";
                // å¢åŠ ä¸€æ¬„é¡¯ç¤ºæ°¨æ°®
                rows += `<tr><td>${i}</td><td>${getAvg('ph')}</td><td>${getAvg('cod')}</td><td>${getAvg('ss')}</td><td>${getAvg('oil')}</td><td>${getAvg('nh3')}</td><td></td></tr>`;
            }

            const html = `
                <div style="font-family:BiauKai;">
                <h2 style="text-align:center; font-size:18pt; margin-bottom:5px;">å°–å±±é›»å» æ”¾æµæ°´æ°´è³ªç´€éŒ„è¡¨</h2>
                
                <div style="text-align:right; margin-bottom:5px;">æ—¥æœŸï¼š${targetY - 1911}å¹´ ${targetM}æœˆ</div>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th><th>PH</th><th>COD</th><th>SS</th><th>OIL</th><th>æ°¨æ°®</th><th>å‚™è¨»</th>
                        </tr>
                        <tr style="background:#eee;">
                            <th>æ¨™æº–</th><th>6~9</th><th><100mg/L</th><th><30 mg/L</th><th><10 mg/L</th><th><100 mg/L</th><th></th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="report-footer" style="display:flex; justify-content:center; gap:80px; margin-top:20px;">
                    <div>ç´€éŒ„:ã€€ã€€ã€€ã€€ç¶“è¾¦:ã€€ã€€ã€€ã€€èª²é•·:</div>
                </div>
                </div>
                <div style="text-align:center; font-size:0.8em; margin-top:0px;">è¡¨æ ¼ï¼šCS-WI-CX-22-F2</div>
            `;
            document.getElementById('waterReportPreview').innerHTML = html;

        }).catch(e => { console.error(e); alert("è®€å–å¤±æ•—"); });
    }

    function exportWaterExcel() {
        const div = document.getElementById('waterReportPreview');
        if (!div || div.innerText === "è«‹é¸æ“‡æœˆä»½ä¸¦é»æ“Šæ›´æ–°") return alert("è«‹å…ˆç”Ÿæˆå ±è¡¨");
        const monthStr = document.getElementById('waterReportMonth').value;
        const filename = `æ”¾æµæ°´æ°´è³ªç´€éŒ„è¡¨_${monthStr}.xls`;
        const template = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><style>table{border-collapse:collapse;}th,td{border:1px solid black;text-align:center;}</style></head><body>${div.innerHTML}</body></html>`;
        const blob = new Blob([template], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }
    
    function printWaterReport() {
        const content = document.getElementById('waterReportPreview').innerHTML;
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>åˆ—å°</title><style>.report-table{width:100%;border-collapse:collapse;} .report-table th, .report-table td{border:1px solid black;padding:4px;text-align:center;} .report-footer{display:flex;justify-content:center;gap:80px;margin-top:20px;}</style></head><body>');
        printWindow.document.write(content); printWindow.document.write('</body></html>'); printWindow.document.close(); printWindow.print();
    }

    let historyData = null; let myChart = null; function openChartModal() { document.getElementById('chartModal').style.display = 'block'; renderCheckboxes(); if (!historyData) fetchHistory(); } function closeChartModal() { document.getElementById('chartModal').style.display = 'none'; } function fetchHistory() { fetch(API_URL + "?mode=history").then(res => res.json()).then(json => { historyData = json; updateChart(); }); } function renderCheckboxes() { const cat = document.getElementById('categorySelect').value; const container = document.getElementById('tagCheckboxes'); container.innerHTML = ''; let items = []; DASHBOARD_CONFIG.forEach(group => { group.items.forEach(item => { if (item.cat === cat) items.push(item); }); }); items.forEach((item, index) => { container.innerHTML += `<label style="display:inline-block; margin-right:10px; color:var(--text-main);"><input type="checkbox" value="${item.col}" id="chk_${item.col}" ${index===0?'checked':''} onchange="updateChart()"> ${item.name}</label>`; }); updateChart(); } function updateChart() { if (!historyData) return; const timeRangeHours = parseInt(document.getElementById('timeRange').value); const headers = historyData.headers; const rawRows = historyData.data; const checkboxes = document.querySelectorAll('#tagCheckboxes input:checked'); const selectedCols = []; checkboxes.forEach(chk => { const idx = headers.indexOf(chk.value); if (idx !== -1) selectedCols.push({ idx: idx, label: chk.parentNode.textContent.trim(), data: [] }); }); const now = new Date(); const labels = []; rawRows.forEach(row => { let timeStr = row[0]; let rowDate = new Date(timeStr); let diffHours = (now - rowDate) / 1000 / 60 / 60; if (diffHours <= timeRangeHours) { let label = rowDate.getMonth()+1 + "/" + rowDate.getDate() + " " + rowDate.getHours() + ":" + (rowDate.getMinutes()<10?'0':'') + rowDate.getMinutes(); labels.push(label); selectedCols.forEach(col => { col.data.push(row[col.idx]); }); } }); const ctx = document.getElementById('myChart').getContext('2d'); if (myChart) myChart.destroy(); const isDark = document.body.getAttribute("data-theme") === "dark"; const gridColor = isDark ? '#444' : '#ddd'; const textColor = isDark ? '#eee' : '#666'; const colors = ['#007bff', '#28a745', '#dc3545', '#fd7e14', '#6f42c1', '#17a2b8', '#e83e8c', '#343a40']; Chart.defaults.color = textColor; Chart.defaults.borderColor = gridColor; myChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: selectedCols.map((col, i) => ({ label: col.label, data: col.data, borderColor: colors[i % colors.length], borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 })) }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { maxTicksLimit: 10 } } } } }); }
    function toggleTheme() { const body = document.body; const newTheme = body.getAttribute("data-theme") === "dark" ? "light" : "dark"; body.setAttribute("data-theme", newTheme); localStorage.setItem("theme", newTheme); document.getElementById("themeBtn").innerHTML = newTheme === "dark" ? "â˜€ï¸" : "ğŸŒ“"; if(myChart) updateChart(); }
</script>

</body>
</html>
