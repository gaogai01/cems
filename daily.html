<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¯æ—¥å·¡æŸ¥ç´€éŒ„ - å°–å±±ç™¼é›»å» </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --bg-body: #f4f7f6; --bg-card: #ffffff; --text-main: #2c3e50; --text-sub: #666; --text-value: #2c3e50;
            --border-color: #e0e0e0; --primary: #007bff; 
            --gauge-grad: linear-gradient(90deg, #ffeb3b, #4caf50); --gauge-bg: #e9ecef;
        }
        [data-theme="dark"] { 
            --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --text-sub: #aaa; --text-value: #ffffff;
            --border-color: #333; --gauge-bg: #333;
        }
        
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s; overflow-x: hidden; }
        .container { max-width: 100%; margin: 0 auto; padding: 10px 20px; }

        /* æ¨™é¡Œå€ */
        .page-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap; gap: 10px;
        }
        .header-left { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        h2 { margin: 0; font-size: 1.4rem; border-left: 6px solid var(--primary); padding-left: 12px; }

        .date-pill {
            background: #4a5568; color: white; padding: 5px 12px; border-radius: 50px;
            font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .date-note { font-size: 0.7rem; opacity: 0.8; font-weight: normal; margin-left: 5px; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; gap: 10px; }
        .btn-log { 
            background: #28a745; color: white; border: none; padding: 8px 16px; 
            border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; white-space: nowrap;
        }
        .btn-log:hover { background: #218838; transform: translateY(-2px); }
        
        .btn-report {
            background: #17a2b8; color: white; border: none; padding: 8px 16px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; white-space: nowrap;
        }
        .btn-report:hover { background: #138496; transform: translateY(-2px); }

        /* --- 4å€‹ç¾¤çµ„ä¸€åˆ—é¡¯ç¤º --- */
        .group-container {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;
        }
        .system-group {
            background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 10px; padding: 15px;
            display: flex; flex-direction: column; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .group-header { 
            font-size: 1.1rem; font-weight: bold; padding-bottom: 8px; margin-bottom: 5px;
            border-bottom: 3px solid; color: var(--text-main); text-align: center;
        }
        .group-recycle { border-bottom-color: #007bff; color: #007bff; }
        .group-desalt  { border-bottom-color: #17a2b8; color: #17a2b8; }
        .group-storage { border-bottom-color: #28a745; color: #28a745; }
        .group-urea    { border-bottom-color: #6f42c1; color: #6f42c1; }

        .inner-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .card {
            background: var(--bg-body); border-radius: 8px; padding: 10px; 
            border: 1px solid var(--border-color); position: relative; border-top: 3px solid #ccc;
        }
        .card.recycle { border-top-color: #007bff; }
        .card.desalt  { border-top-color: #17a2b8; }
        .card.storage { border-top-color: #28a745; }
        .card.urea    { border-top-color: #6f42c1; }

        .card h3 { margin: 0 0 5px 0; font-size: 0.85rem; color: var(--text-sub); font-weight: bold; display: flex; justify-content: space-between; }
        .data-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
        .value { font-size: 1.4rem; font-weight: 800; color: var(--text-value); line-height: 1; }
        .unit { font-size: 0.75rem; color: var(--text-sub); }
        .gauge-container { height: 8px; width: 100%; background: var(--gauge-bg); border-radius: 4px; position: relative; overflow: hidden; }
        .gauge-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ffeb3b, #4caf50); border-radius: 4px; transition: width 0.5s ease-out; }
        .info-text { 
            font-size: 0.75rem; color: var(--text-sub); margin-top: 6px; 
            background: rgba(0,0,0,0.05); padding: 3px 5px; border-radius: 4px; text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .info-highlight { font-weight: bold; color: var(--text-main); }

        /* åœ–è¡¨ */
        .chart-card { background: var(--bg-card); border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border-color); width: 100%; box-sizing: border-box; }
        .chart-header { margin-bottom: 15px; border-left: 5px solid #666; padding-left: 10px; font-size: 1.2rem; font-weight: bold; }
        .chart-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        select { padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); font-size: 0.9rem; }
        .chart-box { position: relative; height: 400px; width: 100%; }
        
        /* Modal & å ±è¡¨æ¨£å¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { background-color: var(--bg-card); margin: 2% auto; padding: 20px; border-radius: 10px; width: 95%; max-width: 1200px; max-height: 95vh; display:flex; flex-direction:column; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .modal-body { overflow-y: auto; padding: 10px; flex:1; }
        .modal-body textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; background: var(--bg-body); color: var(--text-main); }
        .log-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .close-btn { font-size: 1.5rem; cursor: pointer; color: var(--text-sub); }

        /* æœˆå ±è¡¨å°ˆç”¨è¡¨æ ¼æ¨£å¼ */
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; color: #000; background: #fff; }
        .report-table th, .report-table td { border: 1px solid #333; padding: 4px; text-align: center; white-space: nowrap; }
        .report-table th { background-color: #f0f0f0; font-weight: bold; }
        .report-title { font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 5px; color: #000; }
        .report-subtitle { font-size: 1rem; text-align: center; margin-bottom: 15px; color: #000; }
        .report-footer { margin-top: 20px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; font-size: 0.9rem; color: #000; }

        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; color: #888; }

        /* RWD */
        @media (max-width: 1200px) { .group-container { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) {
            .group-container { grid-template-columns: 1fr; } 
            .chart-controls { flex-direction: column; align-items: stretch; }
            .chart-box { height: 300px; }
            .page-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .btn-group { width: 100%; justify-content: space-between; }
            .inner-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<div id="navbar-placeholder"></div>

<div id="loading">è³‡æ–™è¼‰å…¥ä¸­...</div>

<div class="container" id="mainApp" style="display:none;">
    
    <div class="page-header">
        <div class="header-left">
            <h2>æœ€æ–°æ•¸æ“šç¸½è¦½</h2>
            <span class="date-pill" id="lastDatePill">...</span>
        </div>
        <div class="btn-group">
            <button class="btn-report" onclick="openReportModal()">ğŸ“Š ç”¢ç”Ÿæœˆå ±è¡¨</button>
            <button class="btn-log" onclick="openLogModal()">ğŸ“‹ ç”¢ç”Ÿå·¥ä½œæ—¥èªŒ</button>
        </div>
    </div>
    
    <div class="group-container">
        <div class="system-group">
            <div class="group-header group-recycle">æ”¾æµæ°´ç³»çµ±</div>
            <div id="gridRecycle" class="inner-grid"></div>
        </div>
        <div class="system-group">
            <div class="group-header group-desalt">æµ·æ·¡æ©Ÿçµ„</div>
            <div id="gridDesalt" class="inner-grid"></div>
        </div>
        <div class="system-group">
            <div class="group-header group-storage">å„²æ°´ç®¡ç†</div>
            <div id="gridStorage" class="inner-grid"></div>
        </div>
        <div class="system-group">
            <div class="group-header group-urea">å°¿ç´ ç®¡ç†</div>
            <div id="gridUrea" class="inner-grid"></div>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">æ­·å²è¶¨å‹¢åˆ†æ</div>
        <div class="chart-controls">
            <label style="color:var(--text-main)">é …ç›®ï¼š</label>
            <select id="chartParam" onchange="updateLineChart()"></select>
            <label style="color:var(--text-main)">ç¯„åœï¼š</label>
            <select id="timeRange" onchange="updateLineChart()">
                <option value="720">è¿‘ 30 å¤© (æ¯æœˆ)</option>
                <option value="168">è¿‘ 7 å¤©</option>
                <option value="24">è¿‘ 24 å°æ™‚</option>
            </select>
        </div>
        <div class="chart-box">
            <canvas id="lineChart"></canvas>
        </div>
    </div>
</div>

<div id="logModal" class="modal">
    <div class="modal-content" style="max-width:600px;">
        <div class="modal-header">
            <h3 style="margin:0; color:var(--text-main);">å·¥ä½œæ—¥èªŒç”¢ç”Ÿå™¨</h3>
            <span class="close-btn" onclick="closeLogModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="log-controls">
                <label style="color:var(--text-main)">æ—¥æœŸï¼š</label>
                <input type="date" id="logDate" style="padding:5px;">
                <button class="btn-log" onclick="generateLog()">ç”Ÿæˆ</button>
            </div>
            <textarea id="logResult" placeholder="æ—¥èªŒå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
            <div style="margin-top:10px; text-align:right;">
                <button class="btn-log" style="background:#007bff;" onclick="copyLog()">è¤‡è£½å…§å®¹</button>
            </div>
        </div>
    </div>
</div>

<div id="reportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0; color:var(--text-main);">æµ·æ·¡é€ æ°´é‡æœˆå ±è¡¨</h3>
            <span class="close-btn" onclick="closeReportModal()">&times;</span>
        </div>
        <div class="log-controls" style="padding: 0 10px;">
            <label style="color:var(--text-main)">é¸æ“‡æœˆä»½ï¼š</label>
            <input type="month" id="reportMonth" style="padding:5px;">
            <button class="btn-report" onclick="generateReport()">ç”Ÿæˆå ±è¡¨</button>
            <button class="btn-log" style="background:#6c757d;" onclick="printReport()">ğŸ–¨ï¸ åˆ—å°/å­˜PDF</button>
        </div>
        <div class="modal-body" id="reportContainer" style="background:white; color:black; padding:20px;">
            <div style="text-align:center; color:#888;">è«‹é¸æ“‡æœˆä»½ä¸¦é»æ“Šç”Ÿæˆ</div>
        </div>
    </div>
</div>

<script src="common.js"></script>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzJzoU4IyAc6CeKydjbM8iYVyPMsFvMfoR_I50OT7vyNPpH7BZBjlWGEt_DdnUtlUw/exec"; 
    
    let rawData = null;
    let lineChart = null;

    function startApp() {
        fetchData();
        setInterval(fetchData, 60000);
        document.getElementById('logDate').valueAsDate = new Date();
        document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7); 
    }

    async function fetchData() {
        try {
            const res = await fetch(API_URL + "?mode=daily");
            const json = await res.json();
            if (json.error) { console.error(json.error); return; }

            if (json.data && json.data.length > 0) {
                rawData = json;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                renderAllGroups();
                initDropdown();
                updateLineChart();
            }
        } catch (e) { console.error("Error:", e); }
    }

    function renderAllGroups() {
        let latestRow = null;
        const today = new Date(); today.setHours(23, 59, 59, 999);

        for (let i = rawData.data.length - 1; i >= 0; i--) {
            const rowDateStr = rawData.data[i][0];
            const rowDataVal = rawData.data[i][2];
            if (rowDateStr && rowDataVal) {
                const rowDate = new Date(rowDateStr);
                if (rowDate <= today) { latestRow = rawData.data[i]; break; }
            }
        }
        
        if (!latestRow) return;
        
        let dateStr = latestRow[0];
        if(dateStr.includes('T')) dateStr = dateStr.split('T')[0];
        document.getElementById('lastDatePill').innerHTML = `${dateStr} <span class="date-note">(äººå·¥è¼¸å…¥)</span>`;

        const headerMap = {};
        rawData.headers.forEach((h, i) => { if(h) headerMap[h.trim()] = i; });

        const groups = {
            "gridRecycle": { class: "recycle", items: ["å›æ”¶æ°´é‡"] },
            "gridDesalt":  { class: "desalt",  items: ["1è™Ÿæ©Ÿé€ æ°´é‡", "2è™Ÿæ©Ÿé€ æ°´é‡", "1è™Ÿæ©Ÿæµ·æ°´å£“åŠ›", "2è™Ÿæ©Ÿæµ·æ°´å£“åŠ›"] },
            "gridStorage": { class: "storage", items: ["15000å…¬ç§‰å„²æ°´ä½", "ç”¨æ°´é‡"] },
            "gridUrea":    { class: "urea",    items: ["å°¿ç´ æ¯”é‡", "å°¿ç´ ç”¨é‡", "å°¿ç´ åº«å­˜"] }
        };

        for (const [gridId, config] of Object.entries(groups)) {
            const container = document.getElementById(gridId);
            container.innerHTML = "";

            config.items.forEach(field => {
                const idx = headerMap[field];
                if (idx === undefined) return;

                const val = parseFloat(latestRow[idx]);
                const max = parseFloat(rawData.limits[idx]) || 100; 
                const unit = rawData.units[idx] || "";
                
                let displayVal = isNaN(val) ? "--" : val;
                let pct = isNaN(val) ? 0 : (val / max) * 100;
                if (pct > 100) pct = 100;

                let extraInfo = "";
                if (field === "15000å…¬ç§‰å„²æ°´ä½" && !isNaN(val)) {
                    let volume = (val * 2950).toLocaleString(undefined, {maximumFractionDigits: 0});
                    extraInfo = `æ›ç®—: <span class="info-highlight">${volume}</span> å…¬ç§‰`;
                }
                else if (field.includes("æ°´é‡") || field.includes("ç”¨é‡")) {
                    let stats = calcHistoryStats(idx, 30);
                    extraInfo = `30æ—¥å¹³å‡: <span class="info-highlight">${stats.avg.toFixed(1)}</span>`;
                }
                else if (field === "å°¿ç´ æ¯”é‡" && !isNaN(val)) {
                    let conc = ((val - 1) * 1000 / 2.78).toFixed(1);
                    extraInfo = `æ¿ƒåº¦: <span class="info-highlight">${conc}%</span>`;
                }
                else {
                    extraInfo = `ä¸Šé™: ${max}`;
                }

                const card = document.createElement('div');
                card.className = `card ${config.class}`;
                card.innerHTML = `
                    <h3>${field}</h3>
                    <div class="data-row">
                        <span class="value">${displayVal}</span>
                        <span class="unit">${unit}</span>
                    </div>
                    <div class="gauge-container">
                        <div class="gauge-bar" style="width: ${pct}%"></div>
                    </div>
                    <div class="info-text">${extraInfo}</div>
                `;
                container.appendChild(card);
            });
        }
    }

    function calcHistoryStats(colIdx, days) {
        let sum = 0, count = 0;
        let validData = rawData.data.filter(row => row[0] && row[colIdx] && !isNaN(parseFloat(row[colIdx])));
        let start = Math.max(0, validData.length - days);
        for (let i = start; i < validData.length; i++) {
            let v = parseFloat(validData[i][colIdx]);
            sum += v; count++;
        }
        return { sum: sum, avg: count > 0 ? sum / count : 0 };
    }

    // --- æœˆå ±è¡¨ç”¢ç”Ÿå™¨ (æ›´æ–°æ¬„ä½èˆ‡å››æ¨äº”å…¥) ---
    function openReportModal() { document.getElementById('reportModal').style.display = 'block'; }
    function closeReportModal() { document.getElementById('reportModal').style.display = 'none'; }
    
    function generateReport() {
        const monthStr = document.getElementById('reportMonth').value;
        if (!monthStr) return alert("è«‹é¸æ“‡æœˆä»½");
        
        const [year, month] = monthStr.split('-');
        const container = document.getElementById('reportContainer');
        container.innerHTML = "å ±è¡¨ç”Ÿæˆä¸­...";

        const hMap = {}; rawData.headers.forEach((h, i) => { if(h) hMap[h.trim()] = i; });
        const getVal = (row, name) => { let v = parseFloat(row[hMap[name]]); return isNaN(v) ? 0 : v; };
        const getRaw = (row, name) => row[hMap[name]] || "";

        const monthData = rawData.data.filter(row => {
            let d = row[0].replace(/\//g, '-');
            return d.startsWith(monthStr);
        }).sort((a,b) => a[0].localeCompare(b[0]));

        if (monthData.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:20px;">ç„¡ ${year}å¹´${month}æœˆ è³‡æ–™</div>`;
            return;
        }

        let html = `
            <div class="report-title">å°–å±±ç™¼é›»å» æµ·æ°´æ·¡åŒ–å» é€ æ°´é‡çµ±è¨ˆè¡¨</div>
            <div class="report-subtitle">æœˆä»½: ${year}å¹´${month}æœˆ</div>
            <table class="report-table">
                <thead>
                    <tr>
                        <th rowspan="3">æ—¥æœŸ</th>
                        <th rowspan="3">æ˜ŸæœŸ</th>
                        <th colspan="3">æµ·æ·¡é€ æ°´é‡(å™¸)</th>
                        <th rowspan="3">ç•¶æ—¥<br>ç”¨æ°´é‡<br>(å™¸)</th>
                        <th colspan="3">15000å™¸å„²æ°´æ§½</th>
                        <th colspan="4">è’¸æ°£</th>
                        <th colspan="2">é‹è½‰æ©Ÿçµ„æ•¸</th>
                        <th rowspan="3">æµ·æ°´å…¥å£<br>å£“åŠ›(bar)</th>
                    </tr>
                    <tr>
                        <th rowspan="2">#1æ©Ÿ</th>
                        <th rowspan="2">#2æ©Ÿ</th>
                        <th rowspan="2">ç¸½è¨ˆ</th>
                        <th rowspan="2">æ¶²ä½<br>(m)</th>
                        <th rowspan="2">å¢æ¸›<br>(m)</th>
                        <th rowspan="2">å„²æ°´é‡<br>(å™¸)</th>
                        <th rowspan="2">æº«åº¦<br>(â„ƒ)</th>
                        <th rowspan="2">å£“åŠ›<br>(bar)</th>
                        <th colspan="2">æµé‡(T/H)</th>
                        <th rowspan="2">ä¸Šåˆ</th>
                        <th rowspan="2">ä¸‹åˆ</th>
                    </tr>
                    <tr>
                        <th>ä¸Šåˆ</th>
                        <th>ä¸‹åˆ</th>
                    </tr>
                </thead>
                <tbody>
        `;

        let total1=0, total2=0, totalAll=0, totalUse=0;
        let count = 0;
        let prevLevel = null;

        const firstDayIndex = rawData.data.indexOf(monthData[0]);
        if (firstDayIndex > 0) {
            let prevRow = rawData.data[firstDayIndex - 1];
            prevLevel = parseFloat(prevRow[hMap["15000å…¬ç§‰å„²æ°´ä½"]]);
        }

        monthData.forEach(row => {
            const dateObj = new Date(row[0]);
            const day = dateObj.getDate();
            const weekDay = row[1];
            
            const v1 = getVal(row, "1è™Ÿæ©Ÿé€ æ°´é‡");
            const v2 = getVal(row, "2è™Ÿæ©Ÿé€ æ°´é‡");
            const vTotal = v1 + v2;
            const vUse = getVal(row, "ç”¨æ°´é‡");
            const vLevel = getVal(row, "15000å…¬ç§‰å„²æ°´ä½");
            const vStock = (vLevel * 2950).toFixed(0);
            
            const stTemp = getRaw(row, "è’¸æ°£æº«åº¦");
            const stPress = getRaw(row, "è’¸æ°£å£“åŠ›");
            const stFlowAM = getRaw(row, "ä¸Šåˆè’¸æ°£æµé‡");
            const stFlowPM = getRaw(row, "ä¸‹åˆè’¸æ°£æµé‡");
            
            // æµ·æ°´å…¥å£å£“åŠ› (å– max)
            const seaP1 = getVal(row, "1è™Ÿæ©Ÿæµ·æ°´å£“åŠ›");
            const seaP2 = getVal(row, "2è™Ÿæ©Ÿæµ·æ°´å£“åŠ›");
            const seaMax = Math.max(seaP1, seaP2);

            const boilerAM = getRaw(row, "ä¸Šåˆé‹çˆæ•¸").split('ã€').length || 0;
            const boilerPM = getRaw(row, "ä¸‹åˆé‹çˆæ•¸").split('ã€').length || 0;

            let diff = 0;
            if (prevLevel !== null && !isNaN(prevLevel)) { diff = vLevel - prevLevel; }
            prevLevel = vLevel; 

            total1 += v1; total2 += v2; totalAll += vTotal; totalUse += vUse;
            count++;

            html += `
                <tr>
                    <td>${month}æœˆ${day}æ—¥</td>
                    <td>${weekDay}</td>
                    <td>${v1}</td>
                    <td>${v2}</td>
                    <td>${vTotal}</td>
                    <td>${vUse}</td>
                    <td>${vLevel}</td>
                    <td style="color:${diff<0?'red':'black'}">${diff.toFixed(2)}</td>
                    <td>${Number(vStock).toLocaleString()}</td>
                    <td>${stTemp}</td>
                    <td>${stPress}</td>
                    <td>${stFlowAM}</td>
                    <td>${stFlowPM}</td>
                    <td>${boilerAM}</td>
                    <td>${boilerPM}</td>
                    <td>${seaMax}</td>
                </tr>
            `;
        });

        // é å°¾çµ±è¨ˆ (å››æ¨äº”å…¥åˆ°å°æ•¸é»ç¬¬ä¸€ä½)
        html += `
                <tr style="background:#f9f9f9; font-weight:bold;">
                    <td colspan="2">ç¸½è¨ˆ</td>
                    <td>${total1.toFixed(1)}</td>
                    <td>${total2.toFixed(1)}</td>
                    <td>${totalAll.toFixed(1)}</td>
                    <td>${totalUse.toFixed(1)}</td>
                    <td colspan="10"></td>
                </tr>
                <tr style="background:#f9f9f9; font-weight:bold;">
                    <td colspan="2">å¹³å‡</td>
                    <td>${(total1/count).toFixed(1)}</td>
                    <td>${(total2/count).toFixed(1)}</td>
                    <td>${(totalAll/count).toFixed(1)}</td>
                    <td>${(totalUse/count).toFixed(1)}</td>
                    <td colspan="10"></td>
                </tr>
            </tbody>
        </table>
        
        <div class="report-footer">
            <div>ç¶“è¾¦: </div>
            <div>èª²é•·: </div>
            <div>é‹è½‰çµ„: </div>
            <div>å‰¯å» é•·: </div>
            <div>å» é•·: </div>
        </div>
        `;

        container.innerHTML = html;
    }

    function printReport() {
        const content = document.getElementById('reportContainer').innerHTML;
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>æœˆå ±è¡¨åˆ—å°</title>');
        printWindow.document.write('<style>table{width:100%;border-collapse:collapse;} th,td{border:1px solid black;padding:4px;text-align:center;font-size:12px;} .report-title{text-align:center;font-size:18px;font-weight:bold;} .report-footer{display:flex;justify-content:space-between;margin-top:20px;}</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(content);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    // --- æ—¥èªŒèˆ‡åœ–è¡¨ (åŒå‰) ---
    async function generateLog() {
        const dateStr = document.getElementById('logDate').value;
        if (!dateStr) return alert("è«‹é¸æ“‡æ—¥æœŸ");
        const targetDate = new Date(dateStr);
        const dateDisplay = (targetDate.getMonth()+1) + "æœˆ" + targetDate.getDate() + "æ—¥";
        document.getElementById('logResult').value = "è³‡æ–™è®€å–ä¸­...";

        const targetYMD = dateStr.replace(/\//g, '-'); 
        let targetRow = null, prevRow = null;
        for (let i = 0; i < rawData.data.length; i++) {
            let d = rawData.data[i][0].split(' ')[0].replace(/\//g, '-');
            if (d === targetYMD) { targetRow = rawData.data[i]; if (i > 0) prevRow = rawData.data[i-1]; break; }
        }
        if (!targetRow) { document.getElementById('logResult').value = "æŸ¥ç„¡è³‡æ–™ã€‚"; return; }

        const hMap = {}; rawData.headers.forEach((h, i) => { if(h) hMap[h.trim()] = i; });
        const getVal = (name) => { let val = targetRow[hMap[name]]; return (val===""||val===undefined)?0:val; };

        const desalt1 = parseFloat(getVal("1è™Ÿæ©Ÿé€ æ°´é‡"))||0; const desalt2 = parseFloat(getVal("2è™Ÿæ©Ÿé€ æ°´é‡"))||0;
        const totalDesalt = desalt1 + desalt2; const waterUsed = getVal("ç”¨æ°´é‡");
        const level = parseFloat(getVal("15000å…¬ç§‰å„²æ°´ä½"));
        const prevLevel = prevRow ? parseFloat(prevRow[hMap["15000å…¬ç§‰å„²æ°´ä½"]]) : level;
        const levelDiff = (level - prevLevel).toFixed(2);
        const levelTrend = levelDiff >= 0 ? "ä¸Šå‡" : "ä¸‹é™";
        const realStock = (level * 2950).toFixed(1);
        const press1 = getVal("1è™Ÿæ©Ÿæµ·æ°´å£“åŠ›"); const press2 = getVal("2è™Ÿæ©Ÿæµ·æ°´å£“åŠ›");
        const amFlow = getVal("ä¸Šåˆè’¸æ°£æµé‡"); const pmFlow = getVal("ä¸‹åˆè’¸æ°£æµé‡");
        const amUnits = getVal("ä¸Šåˆé‹çˆæ•¸"); const pmUnits = getVal("ä¸‹åˆé‹çˆæ•¸"); 
        const amCount = amUnits ? amUnits.toString().split('ã€').length : 0;
        const pmCount = pmUnits ? pmUnits.toString().split('ã€').length : 0;

        let logText = `å·¥ä½œæ—¥æœŸ:${dateDisplay}ã€‚é€ æ°´è¨­å‚™æ“ä½œï¼Œ#1æµ·æ·¡${desalt1>0?'é‹è½‰':'åœæ©Ÿ'}ï¼šé€ æ°´é‡${desalt1}å…¬å™¸;#2æµ·æ·¡${desalt2>0?'é‹è½‰':'åœæ©Ÿ'}ï¼šé€ æ°´é‡${desalt2}å…¬å™¸;ç•¶æ—¥ç¸½é€ æ°´é‡${totalDesalt}å…¬å™¸ï¼Œç•¶æ—¥ç”¨æ°´é‡${waterUsed}å…¬å™¸;15,000å™¸å„²æ°´æ§½æ°´ä½${level}å…¬å°ºï¼Œæ°´ä½${levelTrend}${Math.abs(levelDiff)}å…¬å°ºï¼Œå¯¦éš›å„²æ°´é‡${realStock}å…¬å™¸ï¼Œä¸Šåˆ08:30è’¸æ°£æµé‡${amFlow}å…¬å™¸/å°æ™‚ï¼Œä¸‹åˆ13:30è’¸æ°£æµé‡${pmFlow}å…¬å™¸/å°æ™‚ã€‚`;
        logText += `\nä¸Šåˆæ©Ÿçµ„é‹çˆé‹è½‰${amCount}éƒ¨(${amUnits}è™Ÿæ©Ÿ)ï¼Œä¸‹åˆæ©Ÿçµ„é‹çˆé‹è½‰${pmCount}éƒ¨(${pmUnits}è™Ÿæ©Ÿ)ï¼Œ`;
        logText += `\n${dateDisplay}ä¸Šåˆæµ·æ°´é€²æ°´å£“åŠ›#1:${press1}ã€#2:${press2}barã€‚R.Oç´”æ°´ç³»çµ±ä¿é¤Šç¶­è­·ï¼Œç´”æ°´è¼¸é€è‡³å„ä¾›æ°´æ§½ä½¿ç”¨ã€‚`;
        document.getElementById('logResult').value = logText;
    }

    function copyLog() { const t = document.getElementById('logResult'); t.select(); document.execCommand('copy'); alert("å·²è¤‡è£½ï¼"); }
    function closeLogModal() { document.getElementById('logModal').style.display = 'none'; }
    function openLogModal() { document.getElementById('logModal').style.display = 'block'; }
    window.onclick = function(event) {
        if (event.target == document.getElementById('logModal')) closeLogModal();
        if (event.target == document.getElementById('reportModal')) closeReportModal();
    }

    function initDropdown() {
        const select = document.getElementById('chartParam');
        if (select.options.length > 0) return;
        const targetFields = ["å›æ”¶æ°´é‡", "1è™Ÿæ©Ÿé€ æ°´é‡", "2è™Ÿæ©Ÿé€ æ°´é‡", "15000å…¬ç§‰å„²æ°´ä½", "ç”¨æ°´é‡", "å°¿ç´ æ¯”é‡", "å°¿ç´ ç”¨é‡", "å°¿ç´ åº«å­˜", "1è™Ÿæ©Ÿæµ·æ°´å£“åŠ›", "2è™Ÿæ©Ÿæµ·æ°´å£“åŠ›"];
        for (let i = 2; i < rawData.headers.length; i++) {
            let header = rawData.headers[i].trim();
            if (targetFields.includes(header)) select.innerHTML += `<option value="${i}">${header}</option>`;
        }
    }

    function updateLineChart() {
        const colIdx = parseInt(document.getElementById('chartParam').value);
        const labelName = rawData.headers[colIdx];
        const unit = rawData.units[colIdx] || "";
        const limit = parseFloat(rawData.limits[colIdx]);
        const rangeHours = parseInt(document.getElementById('timeRange').value);
        const now = new Date(); const startTime = new Date(now.getTime() - rangeHours * 60 * 60 * 1000);
        const labels = []; const values = [];
        const today = new Date(); today.setHours(23, 59, 59, 999);

        rawData.data.forEach(row => {
            let d = new Date(row[0]);
            if (d >= startTime && d <= today) {
                let timeLabel = (d.getMonth()+1) + "/" + d.getDate();
                labels.push(timeLabel); values.push(parseFloat(row[colIdx]) || null);
            }
        });

        const ctx = document.getElementById('lineChart').getContext('2d');
        if (lineChart) lineChart.destroy();
        const datasets = [{ label: labelName, data: values, borderColor: '#007bff', backgroundColor: 'rgba(0, 123, 255, 0.1)', borderWidth: 2, pointRadius: 2, fill: true, tension: 0.1 }];
        if (!isNaN(limit)) datasets.push({ label: 'ä¸Šé™', data: new Array(labels.length).fill(limit), borderColor: '#dc3545', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, fill: false });

        lineChart = new Chart(ctx, {
            type: 'line', data: { labels: labels, datasets: datasets },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: {display: true, text: unit} } } }
        });
    }
</script>
</body>
</html>
