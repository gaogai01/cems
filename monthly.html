<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æœˆç’°åŒ–ç´€éŒ„ - å°–å±±ç™¼é›»å» </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --bg-body: #f4f7f6; --bg-card: #ffffff; --text-main: #2c3e50; --text-sub: #666; --primary: #007bff; 
            --border-color: #e0e0e0;
            --trend-up: #dc3545;   /* ç´…è‰² */
            --trend-down: #28a745; /* ç¶ è‰² */
            --gauge-bg: #e9ecef;
            --gauge-grad: linear-gradient(90deg, #ffeb3b, #4caf50); /* é»ƒç¶ æ¼¸å±¤ */
        }
        [data-theme="dark"] { 
            --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --text-sub: #aaa;
            --border-color: #333; --gauge-bg: #333;
        }
        
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }

        /* æ¨™é¡Œèˆ‡ç¯©é¸å€ */
        .page-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 15px;
            flex-wrap: wrap; gap: 10px;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        h2 { margin: 0; font-size: 1.4rem; border-left: 6px solid var(--primary); padding-left: 12px; }

        .filter-group { display: flex; gap: 10px; align-items: center; }
        .filter-group select { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); font-size: 1rem; cursor: pointer; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-report {
            background: #6f42c1; color: white; border: none; padding: 8px 16px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; white-space: nowrap;
        }
        .btn-report:hover { background: #59359a; transform: translateY(-2px); }
        .btn-word { background: #2b579a; color:white; }
        .btn-print { background: #6c757d; color:white; }

        /* ç¾¤çµ„å®¹å™¨ */
        .group-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .system-group { background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 10px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; }
        .group-header { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; padding-bottom: 8px; border-bottom: 3px solid var(--primary); color: var(--text-main); text-align: center; }
        
        .inner-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* å¡ç‰‡æ¨£å¼ (å‡ç´šç‰ˆ) */
        .card { 
            background: var(--bg-body); border-radius: 8px; padding: 10px; 
            border: 1px solid var(--border-color); position: relative; 
            overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; 
        }
        .card-title { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 5px; font-weight: bold; min-height: 2.4em; display: flex; align-items: center; justify-content: space-between; }
        .card-value-row { display: flex; align-items: baseline; gap: 5px; margin-bottom: 5px; }
        .card-value { font-size: 1.4rem; font-weight: 800; color: var(--text-main); line-height: 1.2; }
        .card-unit { font-size: 0.75rem; color: var(--text-sub); }
        
        /* å„€è¡¨æ¿æ¢ */
        .gauge-container { height: 6px; width: 100%; background: var(--gauge-bg); border-radius: 3px; position: relative; overflow: hidden; margin-bottom: 5px; }
        .gauge-bar { height: 100%; width: 0%; background: var(--gauge-grad); border-radius: 3px; transition: width 0.5s ease-out; }
        
        .card-sub { font-size: 0.75rem; color: var(--text-sub); display: flex; align-items: center; justify-content: space-between; gap: 5px; background: rgba(0,0,0,0.03); padding: 4px; border-radius: 4px; }
        .card-limit { font-size: 0.7rem; color: #999; font-weight: normal; }

        .trend-up { color: var(--trend-up); font-weight: bold; }
        .trend-down { color: var(--trend-down); font-weight: bold; }
        .trend-flat { color: var(--text-sub); }

        /* åœ–è¡¨å€ */
        .chart-section { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border-color); margin-top: 30px; }
        .chart-header { margin-bottom: 15px; border-left: 5px solid #666; padding-left: 10px; font-size: 1.2rem; font-weight: bold; color: var(--text-main); }
        .chart-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        select { padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); font-size: 0.9rem; }
        .chart-box { position: relative; height: 400px; width: 100%; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { background-color: var(--bg-card); margin: 2% auto; padding: 20px; border-radius: 10px; width: 95%; max-width: 900px; max-height: 95vh; display:flex; flex-direction:column; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .modal-body { overflow-y: auto; padding: 20px; flex:1; background: white; color: black; }
        .close-btn { font-size: 1.5rem; cursor: pointer; color: var(--text-sub); }
        .btn-toolbar { display: flex; gap: 10px; justify-content: flex-end; margin-bottom: 10px; flex-wrap: wrap; }
        
        .report-controls { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 10px; align-items: center; border: 1px solid #ddd; }

        /* å» å‹™æœƒè­°å ±å‘Šå°ˆç”¨æ¨£å¼ */
        .report-doc { font-family: "BiauKai", "DFKai-SB", serif; line-height: 1.5; color: #000; }
        .report-h1 { font-size: 18pt; font-weight: bold; margin-bottom: 15px; }
        .report-h2 { font-size: 14pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #000; display: inline-block; padding-bottom: 2px; }
        .report-summary { background-color: #f8f9fa; border-left: 4px solid #007bff; padding: 10px; margin-bottom: 20px; font-size: 11pt; }
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11pt; }
        .report-table th, .report-table td { border: 1px solid black; padding: 6px 8px; text-align: center; }
        .report-table th { background-color: #f0f0f0; }
        .text-left { text-align: left !important; }
        .text-red { color: red; font-weight: bold; }
        .text-green { color: green; font-weight: bold; }

        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; color: #888; }

        @media (max-width: 768px) {
            .group-container { grid-template-columns: 1fr; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .chart-controls { flex-direction: column; align-items: stretch; }
            .report-controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

<div id="navbar-placeholder"></div>

<div class="container">
    <div class="page-header">
        <div class="header-left">
            <h2>æ¯æœˆç’°åŒ–ç´€éŒ„</h2>
        </div>
        <div class="filter-group">
            <button class="btn-report" onclick="openFactoryReport()">ğŸ“ ç”¢ç”Ÿå» å‹™æœƒè­°å ±å‘Š</button>
            <select id="selYear" onchange="renderGroupedCards()"></select>
            <select id="selMonth" onchange="renderGroupedCards()">
                <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option>
                <option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
                <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
                <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
            </select>
        </div>
    </div>

    <div id="loading">è³‡æ–™è¼‰å…¥ä¸­...</div>

    <div id="groupContainer" class="group-container"></div>

    <div class="chart-section" id="chartSection" style="display:none;">
        <div class="chart-header">å¹´åº¦æ¯”è¼ƒåˆ†æ</div>
        <div class="chart-controls">
            <label style="color:var(--text-main)">æ¯”è¼ƒé …ç›®ï¼š</label>
            <select id="chartParam" onchange="updateChart()"></select>
        </div>
        <div class="chart-box">
            <canvas id="comparisonChart"></canvas>
        </div>
    </div>
</div>

<div id="reportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0; color:var(--text-main);">å» å‹™æœƒè­°å ±å‘Šé è¦½</h3>
            <span class="close-btn" onclick="closeReportModal()">&times;</span>
        </div>
        
        <div class="report-controls">
            <label style="color:#333; font-weight:bold;">é¸æ“‡å ±å‘Šæœˆä»½ï¼š</label>
            <select id="reportYear" style="padding:5px;"></select>
            <select id="reportMonth" style="padding:5px;">
                <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option>
                <option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
                <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
                <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
            </select>
            <button class="btn-report" onclick="generateReportContent()">ğŸ”„ æ›´æ–°é è¦½</button>
        </div>

        <div class="btn-toolbar">
            <button class="btn-report btn-word" onclick="exportToWord()">ğŸ“„ ä¸‹è¼‰ Word</button>
            <button class="btn-report btn-print" onclick="printReport()">ğŸ–¨ï¸ åˆ—å° / å­˜ PDF</button>
        </div>
        
        <div class="modal-body" id="reportPreview">
            </div>
    </div>
</div>

<script src="common.js"></script>
<script>
    // â–¼ è«‹å¡«å…¥ç¨ç«‹ç‰ˆ Monthly GS ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbwXoH46dO4rlR2XhZ2PFflCTeRooroVBPADiRltxTa-Jp05uZc9sk2OsGKKSzN92ryxtg/exec"; 
    
    let apiData = null; 
    let chartInstance = null;

    function startApp() {
        fetchData();
    }

    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            
            if (json.error) { alert(json.error); return; }
            
            apiData = json;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('chartSection').style.display = 'block';
            
            initDateControls();
            
            // 1. è‡ªå‹•é–å®šã€Œæœ€æ–°ä¸”æ•¸æ“šå®Œæ•´ã€çš„æœˆä»½
            selectLatestCompleteMonth();
            
            renderGroupedCards();
            initDropdown();
            updateChart();
            
        } catch (e) {
            console.error(e);
            document.getElementById('loading').innerText = "è¼‰å…¥å¤±æ•— (è«‹æª¢æŸ¥ç¶²å€æˆ–è©¦ç®—è¡¨æ¬Šé™)";
        }
    }

    function initDateControls() {
        const records = apiData.data;
        const years = [...new Set(records.map(r => r['å¹´åº¦']))].sort().reverse();
        
        const selYear = document.getElementById('selYear');
        const reportYear = document.getElementById('reportYear');
        selYear.innerHTML = "";
        reportYear.innerHTML = "";
        
        years.forEach(y => {
            selYear.innerHTML += `<option value="${y}">${y}å¹´</option>`;
            reportYear.innerHTML += `<option value="${y}">${y}å¹´</option>`;
        });
    }

    // --- æ ¸å¿ƒï¼šå°‹æ‰¾æœ€æ–°å®Œæ•´æ•¸æ“šçš„æœˆä»½ ---
    function selectLatestCompleteMonth() {
        const records = apiData.data;
        if (records.length === 0) return;

        // å¾æœ€å¾Œä¸€ç­†å¾€å›æ‰¾
        for (let i = records.length - 1; i >= 0; i--) {
            const row = records[i];
            // æª¢æŸ¥é—œéµæ¬„ä½æ˜¯å¦æœ‰å€¼ (å‡è¨­ 'ç´”æ°´15000å™¸å°é›»ç‡' å’Œ 'å°¿ç´ ç”¨é‡' å¿…å¡«)
            // æ‚¨å¯ä»¥æ ¹æ“šå¯¦éš›æƒ…æ³èª¿æ•´é€™è£¡çš„æª¢æŸ¥é‚è¼¯
            if (row['ç´”æ°´15000å™¸å°é›»ç‡'] && row['å°¿ç´ ç”¨é‡']) {
                document.getElementById('selYear').value = row['å¹´åº¦'];
                document.getElementById('selMonth').value = parseInt(row['æœˆä»½']);
                // åŒæ­¥æ›´æ–°å ±å‘Šé¸å–®
                document.getElementById('reportYear').value = row['å¹´åº¦'];
                document.getElementById('reportMonth').value = parseInt(row['æœˆä»½']);
                return;
            }
        }
        
        // å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œå°±é¸æœ€å¾Œä¸€ç­†
        const last = records[records.length - 1];
        document.getElementById('selYear').value = last['å¹´åº¦'];
        document.getElementById('selMonth').value = parseInt(last['æœˆä»½']);
    }

    function renderGroupedCards() {
        const targetYear = document.getElementById('selYear').value;
        const targetMonth = document.getElementById('selMonth').value;
        
        const targetRecord = apiData.data.find(r => r['å¹´åº¦'] == targetYear && parseInt(r['æœˆä»½']) == targetMonth);
        const prevYearRecord = apiData.data.find(r => r['å¹´åº¦'] == (parseInt(targetYear) - 1) && parseInt(r['æœˆä»½']) == targetMonth);

        const categories = apiData.meta.categories; 
        const headers = apiData.headers;
        const units = apiData.meta.units;
        const uppers = apiData.meta.upper;
        
        // åˆ†çµ„
        const groups = {};
        
        headers.forEach((headerName, index) => {
            if (headerName === "å¹´åº¦" || headerName === "æœˆä»½") return;
            let cat = categories[index] ? categories[index].trim() : "å…¶ä»–";
            if (cat === "") cat = "å…¶ä»–";
            if (!groups[cat]) groups[cat] = [];
            
            const key = headerName.replace(/\n/g, "").trim();
            groups[cat].push({ 
                key: key, 
                name: headerName, 
                unit: units[index] || "",
                limit: uppers[index] || ""
            });
        });

        const container = document.getElementById('groupContainer');
        container.innerHTML = "";

        if (!targetRecord) {
            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:#888;">${targetYear}å¹´${targetMonth}æœˆ ç„¡è³‡æ–™</div>`;
            return;
        }

        for (const [groupName, fields] of Object.entries(groups)) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'system-group';
            groupDiv.innerHTML = `<div class="group-header">${groupName}</div>`;
            
            const innerGrid = document.createElement('div');
            innerGrid.className = 'inner-grid';

            fields.forEach(field => {
                const key = field.key;
                const name = field.name;
                const unit = field.unit;
                const limit = parseFloat(field.limit);
                
                const valNow = parseFloat(targetRecord[key]);
                const displayNow = !isNaN(valNow) ? valNow.toLocaleString() : "--";
                const valPrev = prevYearRecord ? parseFloat(prevYearRecord[key]) : NaN;
                
                // è¨ˆç®—æ¼²è·Œ
                let subText = "";
                if (!isNaN(valNow) && !isNaN(valPrev) && valPrev !== 0) {
                    let diff = valNow - valPrev;
                    let diffPct = (diff / valPrev) * 100;
                    let trendClass = diff > 0 ? "trend-up" : (diff < 0 ? "trend-down" : "trend-flat");
                    let trendIcon = diff > 0 ? "â¬†" : (diff < 0 ? "â¬‡" : "-");
                    subText = `å»å¹´: ${valPrev} <span class="${trendClass}">${trendIcon} ${Math.abs(diffPct).toFixed(1)}%</span>`;
                } else if (prevYearRecord) {
                    subText = `å»å¹´: ${isNaN(valPrev) ? "--" : valPrev}`;
                } else {
                    subText = "ç„¡å»å¹´è³‡æ–™";
                }

                // å„€è¡¨æ¢
                let gaugeHtml = "";
                let limitText = "";
                if (!isNaN(valNow) && !isNaN(limit) && limit > 0) {
                    let pct = Math.min((valNow / limit) * 100, 100);
                    gaugeHtml = `
                        <div class="gauge-container">
                            <div class="gauge-bar" style="width: ${pct}%"></div>
                        </div>
                    `;
                    limitText = `<span class="card-limit">ä¸Šé™: ${limit}</span>`;
                }

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-title">
                        ${name}
                        ${limitText}
                    </div>
                    <div class="card-value-row">
                        <span class="card-value">${displayNow}</span>
                        <span class="card-unit">${unit}</span>
                    </div>
                    ${gaugeHtml}
                    <div class="card-sub">${subText}</div>
                `;
                innerGrid.appendChild(card);
            });

            groupDiv.appendChild(innerGrid);
            container.appendChild(groupDiv);
        }
    }

    function initDropdown() {
        const select = document.getElementById('chartParam');
        const headers = apiData.headers;
        headers.forEach(h => {
            if (h === "å¹´åº¦" || h === "æœˆä»½") return;
            const key = h.replace(/\n/g, "").trim();
            select.innerHTML += `<option value="${key}">${h}</option>`;
        });
    }

    function updateChart() {
        const fieldKey = document.getElementById('chartParam').value;
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        const records = apiData.data;
        const years = [...new Set(records.map(r => r['å¹´åº¦']))].sort().reverse();
        
        const year1 = document.getElementById('selYear').value;
        const year2 = (parseInt(year1) - 1).toString();

        const data1 = new Array(12).fill(null);
        const data2 = new Array(12).fill(null);

        records.forEach(r => {
            const m = parseInt(r['æœˆä»½']) - 1; 
            const val = parseFloat(r[fieldKey]);
            if (r['å¹´åº¦'] == year1) data1[m] = isNaN(val) ? null : val;
            if (r['å¹´åº¦'] == year2) data2[m] = isNaN(val) ? null : val;
        });

        // å–å¾—ä¸Šé™å€¼
        let limitValue = NaN;
        const headerIndex = apiData.headers.findIndex(h => h.replace(/\n/g, "").trim() === fieldKey);
        if (headerIndex !== -1) { limitValue = parseFloat(apiData.meta.upper[headerIndex]); }

        const chartDatasets = [
            { label: `${year1}å¹´`, data: data1, backgroundColor: '#007bff', borderRadius: 4, order: 2 },
            { label: `${year2}å¹´`, data: data2, backgroundColor: '#ced4da', borderRadius: 4, order: 3 }
        ];

        if (!isNaN(limitValue)) {
            chartDatasets.push({ type: 'line', label: `ä¸Šé™ (${limitValue})`, data: new Array(12).fill(limitValue), borderColor: '#dc3545', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, fill: false, order: 1 });
        }

        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"], datasets: chartDatasets },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { title: { display: true, text: `${fieldKey} - å¹´åº¦æ¯”è¼ƒ` }, tooltip: { mode: 'index', intersect: false } } }
        });
    }

    // --- å°ˆæ¥­ç‰ˆå» å‹™å ±å‘Šç”Ÿæˆå™¨ ---
    function openFactoryReport() {
        document.getElementById('reportModal').style.display = 'block';
        // åŒæ­¥å¤–éƒ¨çš„é¸æ“‡åˆ°å…§éƒ¨
        document.getElementById('reportYear').value = document.getElementById('selYear').value;
        document.getElementById('reportMonth').value = document.getElementById('selMonth').value;
        generateReportContent();
    }

    function closeReportModal() { document.getElementById('reportModal').style.display = 'none'; }

    function generateReportContent() {
        const targetYear = document.getElementById('reportYear').value;
        const targetMonth = document.getElementById('reportMonth').value;
        
        const curr = apiData.data.find(r => r['å¹´åº¦'] == targetYear && parseInt(r['æœˆä»½']) == targetMonth);
        if(!curr) { document.getElementById('reportPreview').innerHTML = "<p>ç„¡ç•¶æœˆè³‡æ–™</p>"; return; }

        let lastMonthY = parseInt(targetYear);
        let lastMonthM = parseInt(targetMonth) - 1;
        if(lastMonthM < 1) { lastMonthM = 12; lastMonthY--; }
        const prev = apiData.data.find(r => r['å¹´åº¦'] == lastMonthY && parseInt(r['æœˆä»½']) == lastMonthM);
        const lastYear = apiData.data.find(r => r['å¹´åº¦'] == (parseInt(targetYear)-1) && parseInt(r['æœˆä»½']) == targetMonth);

        const v = (record, key) => record ? (parseFloat(record[key])||0) : 0;
        const fmt = (val) => val.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 1});

        // 1. é‡é»æ‘˜è¦ (å°ˆæ¥­åˆ¤æ–·ï¼šä¸»ç®¡æœ€åœ¨æ„çš„æŒ‡æ¨™)
        // é‚è¼¯ï¼šæª¢æŸ¥é—œéµæŒ‡æ¨™æ˜¯å¦ç•°å¸¸
        let summaryHtml = "<ul>";
        
        // æª¢æŸ¥å°¿ç´ å–®è€— (å‡è¨­ < 9.5 ç‚ºå„ª)
        const ureaIntensity = v(curr, "å°¿ç´ å¼·åº¦");
        if(ureaIntensity > 0) {
            summaryHtml += `<li>æœ¬æœˆå°¿ç´ å¼·åº¦ç‚º <b>${ureaIntensity}</b> å…¬æ–¤/åƒåº¦é›»ï¼Œ`;
            if (prev && ureaIntensity < v(prev, "å°¿ç´ å¼·åº¦")) summaryHtml += "è¼ƒä¸Šæœˆ<span class='text-green'>ä¸‹é™ (æ”¹å–„)</span>ã€‚";
            else if (prev) summaryHtml += "è¼ƒä¸Šæœˆ<span class='text-red'>ä¸Šå‡</span>ã€‚";
            summaryHtml += "</li>";
        }

        // æª¢æŸ¥ç™¼é›»é‡
        const powerGen = v(curr, "ç™¼é›»é‡");
        if(powerGen > 0) {
            summaryHtml += `<li>æœ¬æœˆç¸½ç™¼é›»é‡ <b>${fmt(powerGen)}</b> KWHã€‚</li>`;
        }
        
        summaryHtml += "</ul>";

        // 2. è¡¨æ ¼ç”Ÿæˆ
        const buildTable = (fields) => {
            let rows = fields.map(f => {
                const valCurr = v(curr, f.key);
                const valPrev = v(prev, f.key);
                const valLastY = v(lastYear, f.key);
                
                // è¨ˆç®—æœˆå¢ç‡
                let mom = 0;
                if(valPrev !== 0) mom = ((valCurr - valPrev) / valPrev) * 100;
                let momColor = mom > 0 ? "red" : (mom < 0 ? "green" : "black"); // å‡è¨­æ•¸å€¼å¢åŠ æ¨™ç´…(å¦‚æˆæœ¬/æ±™æŸ“)ï¼Œéœ€è¦–é …ç›®è€Œå®š
                
                return `
                <tr>
                    <td class="text-left">${f.name}</td>
                    <td>${fmt(valCurr)}</td>
                    <td>${fmt(valPrev)}</td>
                    <td style="color:${momColor}">${mom > 0 ? '+' : ''}${mom.toFixed(1)}%</td>
                    <td>${fmt(valLastY)}</td>
                </tr>
            `}).join("");
            
            return `
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="width:30%">é …ç›®</th>
                            <th style="width:15%">æœ¬æœˆ<br>(${targetYear}/${targetMonth})</th>
                            <th style="width:15%">ä¸Šæœˆ<br>(${lastMonthY}/${lastMonthM})</th>
                            <th style="width:15%">æœˆå¢æ¸›%</th>
                            <th style="width:15%">å»å¹´åŒæœˆ<br>(${parseInt(targetYear)-1}/${targetMonth})</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        };

        const fields71 = [
            { key: "ç´”æ°´15000å™¸å°é›»ç‡", name: "15000å™¸å„²æ§½å°é›»ç‡ (Î¼S/cm)" },
            { key: "ç´”æ°´300å™¸å°é›»ç‡", name: "300å™¸å„²æ§½å°é›»ç‡ (Î¼S/cm)" },
            { key: "ç´”æ°´æµ·æ°´æ·¡åŒ–å°é›»ç‡", name: "æµ·æ·¡ç”¢æ°´å°é›»ç‡ (Î¼S/cm)" },
            { key: "æ¬¡æ°¯é…¸éˆ‰é€²å£é¤˜æ°¯", name: "æ¬¡æ°¯é…¸éˆ‰é€²å£é¤˜æ°¯ (ppm)" }
        ];

        const fields72 = [
            { key: "å°¿ç´ ç”¨é‡", name: "å°¿ç´ ç”¨é‡ (å™¸)" },
            { key: "å°¿ç´ å¼·åº¦", name: "å°¿ç´ å¼·åº¦ (å…¬æ–¤/åƒåº¦é›»)" },
            { key: "CEMSç•¶æœˆå¹³å‡NOx", name: "CEMSå¹³å‡NOx (ppm)" },
            { key: "ç™¼é›»é‡", name: "ç¸½ç™¼é›»é‡ (KWH)" }
        ];

        const html = `
            <div class="report-doc">
                <div class="report-h1">(ä¸ƒ)ç’°ä¿åŒ–å­¸èª²é«˜æŒ¯å‡±èª²é•·å ±å‘Šï¼š</div>
                
                <div class="report-summary">
                    <b>ğŸ“Š æœ¬æœˆç‡Ÿé‹æ‘˜è¦ï¼š</b>
                    ${summaryHtml}
                </div>

                <div class="report-h2">7-1ã€æµ·æ°´æ·¡åŒ–ã€ROæ°´åŠæµ·æ°´é›»è§£</div>
                ${buildTable(fields71)}
                
                <div class="report-h2">7-2ã€å°¿ç´ ã€CEMSã€CWMSæº«æ’æ°´</div>
                ${buildTable(fields72)}
                
                <div style="margin-top:20px; font-size:10pt; color:#666;">
                    * å ±è¡¨ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString()}
                </div>
            </div>
        `;

        document.getElementById('reportPreview').innerHTML = html;
    }

    function exportToWord() {
        const content = document.getElementById('reportPreview').innerHTML;
        const filename = `å» å‹™æœƒè­°å ±å‘Š.doc`;
        const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'></head><body>";
        const footer = "</body></html>";
        const sourceHTML = header + content + footer;
        const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
        const fileDownload = document.createElement("a");
        document.body.appendChild(fileDownload);
        fileDownload.href = source;
        fileDownload.download = filename;
        fileDownload.click();
        document.body.removeChild(fileDownload);
    }

    function printReport() {
        const content = document.getElementById('reportPreview').innerHTML;
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>åˆ—å°å ±å‘Š</title>');
        printWindow.document.write('<style>');
        printWindow.document.write('.report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12pt; }');
        printWindow.document.write('.report-table th, .report-table td { border: 1px solid black; padding: 4px 8px; text-align: center; }');
        printWindow.document.write('.report-h1 { font-size: 18pt; font-weight: bold; margin-bottom: 15px; }');
        printWindow.document.write('.report-h2 { font-size: 14pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #000; display: inline-block; }');
        printWindow.document.write('.report-summary { border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; }');
        printWindow.document.write('.text-left { text-align: left !important; } .text-red { color: red; } .text-green { color: green; }');
        printWindow.document.write('</style></head><body>');
        printWindow.document.write(content);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    window.onclick = function(event) { if (event.target == document.getElementById('reportModal')) closeReportModal(); }
</script>
</body>
</html>
